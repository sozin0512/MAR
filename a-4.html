<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Inventario Logístico </title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <!-- Lucide Icons for modern SVG icons -->
    <script src="https://unpkg.com/lucide@latest/dist/lucide.min.js"></script> 
    <!-- Chart.js CDN for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <style>
        /* Estilos personalizados para la fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Caja de mensajes para notificaciones */
        #message-box {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 15px 20px; /* Adjusted padding for mobile */
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            text-align: center;
            width: 90%; /* Responsive width for mobile */
            max-width: 400px; /* Max width for larger screens */
        }
        #message-box.error {
            background-color: #f44336; /* Red */
        }
        #loading-overlay {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-size: 1.2rem; /* Smaller font size for mobile */
            color: #333;
        }

        /* Modals: Ocultos por defecto */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 50; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
            padding: 1rem; /* Added padding for mobile screens */
        }
        .modal.flex { /* Override display: none when showing */
            display: flex;
        }
        .modal > div {
             background-color: #fff;
             padding: 1.5rem; /* Adjusted padding for mobile */
             border-radius: 0.5rem;
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
             width: 100%; /* Full width on small screens */
             max-width: 32rem; /* md:max-w-md for withdrawal, larger for delivery */
        }
        @media (min-width: 768px) { /* Medium screens and up */
            #delivery-invoice-modal > div {
                max-width: 50rem; /* Larger modal for delivery invoice */
            }
            #edit-item-modal > div {
                max-width: 38rem; /* Slightly larger for edit modal */
            }
            #image-search-modal > div { /* Style for image search modal */
                max-width: 48rem; /* Make it wider for camera stream */
            }
            #item-history-modal > div { /* Style for item history modal */
                max-width: 55rem; /* Wider for history table */
            }
        }

        /* Specific styles for camera stream and canvas */
        #camera-feed-container {
            width: 100%;
            background-color: #000;
            border-radius: 0.5rem;
            overflow: hidden; /* Ensure video/canvas stay within bounds */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 200px; /* Minimum height for camera feed area on mobile */
        }
        @media (min-width: 768px) {
            #camera-feed-container {
                min-height: 250px; /* Larger min-height on desktop */
            }
        }
        #camera-feed-container video,
        #camera-feed-container canvas {
            max-width: 100%;
            height: auto; /* Maintain aspect ratio */
            display: block;
        }
        #camera-feed-container #captured-image-preview {
            max-width: 100%;
            height: auto;
            display: none; /* Hidden by default */
        }

        /* Estilos específicos para la tabla dentro del modal de entrega */
        #delivery-items-list th, #delivery-items-list td {
            padding: 0.5rem 0.75rem; /* Adjusted padding for mobile */
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem; /* Smaller font size for mobile tables */
        }
        #delivery-items-list th {
            background-color: #f3f4f6;
        }

        /* Estilos para los resultados de búsqueda en el modal de entrega */
        #delivery-search-results {
            max-height: 150px; /* Smaller height for mobile */
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
            background-color: #fff;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .search-result-item {
            padding: 0.5rem 0.75rem; /* Adjusted padding */
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem; /* Smaller font size */
        }
        .search-result-item:hover {
            background-color: #f9fafb;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }

        /* New styles for print - logos in header */
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .invoice-container, .inventory-container, .report-container { width: 100%; border: none; padding: 0; box-shadow: none; }
            .invoice-header, .inventory-header, .report-header, .signatures-container { page-break-inside: avoid; }
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            
            /* Print-specific header layout */
            .invoice-header .print-logo-left,
            .inventory-header .print-logo-left,
            .report-header .print-logo-left {
                position: absolute;
                left: 20px; /* Adjust as needed */
                top: 50%;
                transform: translateY(-50%);
            }
            .invoice-header .print-logo-right,
            .inventory-header .print-logo-right,
            .report-header .print-logo-right {
                position: absolute;
                right: 20px; /* Adjust as needed */
                top: 50%;
                transform: translateY(-50%);
            }
            .invoice-header h1,
            .inventory-header h1,
            .report-header h1 {
                text-align: center;
                flex-grow: 1; /* Center the title between logos */
                margin: 0 120px; /* Adjust margin to prevent overlap with logos */
            }
            .created-by-text {
                font-family: 'Bebas Neue', sans-serif !important; /* Ensure font applies for print */
                font-size: 0.8em !important;
                color: #555 !important;
                margin-top: 5px !important;
                letter-spacing: 1px !important;
            }
        }

        /* Custom font for "Creado por" text */
        .created-by-text {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem; /* Adjusted for better visibility on mobile */
            color: #d1d5db; /* Light gray to stand out on dark blue */
            margin-top: 5px; /* Space from the main title */
            letter-spacing: 1.5px; /* Spacing for a more distinct look */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); /* Slight shadow for depth */
        }
        @media (min-width: 768px) {
            .created-by-text {
                font-size: 1.2rem; /* Larger on desktop */
            }
        }

        /* Styles for authentication section */
        #auth-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px; /* Smaller min-height for mobile */
            background-color: #f3f4f6;
            padding: 1.5rem; /* Adjusted padding */
            border-radius: 8px;
            box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem; /* Adjusted margin */
            flex-direction: column;
            gap: 0.75rem; /* Adjusted gap */
        }

        #auth-section input {
            width: 100%;
            max-width: 280px; /* Smaller max-width for mobile inputs */
            padding: 0.625rem; /* Adjusted padding */
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem; /* Smaller font size */
        }

        #auth-section button {
            padding: 0.625rem 1.25rem; /* Adjusted padding */
            border-radius: 0.375rem;
            font-weight: 600;
            color: white;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            font-size: 0.875rem; /* Smaller font size */
        }

        #auth-section .bg-blue-600 {
            background-color: #2563eb;
        }
        #auth-section .bg-blue-600:hover {
            background-color: #1d4ed8;
        }
        #auth-section .bg-gray-600 {
            background-color: #4b5563;
        }
        #auth-section .bg-gray-600:hover {
            background-color: #374151;
        }
        
        /* Collapsible section styles */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out; /* Slower transition for content */
        }
        .collapsible-content.expanded {
            max-height: 2000px; /* Large enough to fit content, adjust if needed */
            transition: max-height 0.7s ease-in; /* Slightly faster for expansion */
        }
        /* Style for the chevron icon */
        .chevron-icon {
            transition: transform 0.3s ease;
        }
        .expanded .chevron-icon {
            transform: rotate(180deg);
        }

        /* Style for the inventory table container with scrollbar */
        #inventory-table-container {
            max-height: 400px; /* Adjusted for mobile view */
            overflow-y: auto; /* Enable vertical scrolling */
            overflow-x: auto; /* Enable horizontal scrolling if content overflows */
            border-radius: 0.5rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Optional: add shadow */
            border: 1px solid #e5e7eb; /* Optional: add border */
        }
        @media (min-width: 768px) {
            #inventory-table-container {
                max-height: 500px; /* Larger height on desktop */
            }
        }

        /* Ensure the table within the scroll container takes full width */
        #inventory-table-container table {
            min-width: 100%; /* Ensure table doesn't shrink smaller than container */
            border-collapse: collapse; /* Remove double borders */
        }

        /* Table cell padding and font size for mobile */
        #inventory-table-container th, #inventory-table-container td {
            padding: 0.5rem 0.75rem; /* Adjusted padding for mobile */
            font-size: 0.875rem; /* Smaller font size for mobile tables */
        }
        @media (min-width: 768px) {
            #inventory-table-container th, #inventory-table-container td {
                padding: 0.75rem 1rem; /* Standard padding for desktop */
                font-size: 0.95rem; /* Standard font size for desktop */
            }
        }

        /* Critical items card pulsing animation */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .pulse-red {
            animation: pulse-red 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <!-- Loading Overlay -->
    <div id="loading-overlay">Cargando datos...</div>

    <!-- Caja de mensajes para notificaciones -->
    <div id="message-box" class="rounded-lg shadow-lg"></div>

    <!-- Modal de Retiro de Cantidad (para un solo artículo) -->
    <div id="withdrawal-modal" class="modal">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-sm sm:max-w-md">
            <h3 class="text-xl sm:text-2xl font-bold text-blue-800 mb-4 border-b pb-2">Retirar Cantidad de Artículo</h3>
            <div id="modal-item-details" class="mb-4 text-gray-700 text-sm sm:text-base">
                <p><span class="font-semibold">Número de Parte:</span> <span id="modal-item-id"></span></p>
                <p><span class="font-semibold">Nombre:</span> <span id="modal-item-name"></span></p>
                <p><span class="font-semibold">Cantidad Actual:</span> <span id="modal-item-current-quantity"></span></p>
            </div>
            <div class="mb-4">
                <label for="withdrawal-quantity" class="block text-sm font-medium text-gray-700 mb-1">Cantidad a Retirar:</label>
                <input type="number" id="withdrawal-quantity" min="1" class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label for="withdrawal-responsible" class="block text-sm font-medium text-gray-700 mb-1">Responsable:</label>
                <input type="text" id="withdrawal-responsible" value="Usuario" class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4">
                <button id="cancel-withdrawal-btn" class="py-2 px-4 border border-gray-300 shadow-sm text-sm sm:text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                    Cancelar
                </button>
                <button id="confirm-withdrawal-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm sm:text-base font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
                    Confirmar Retiro
                </button>
            </div>
        </div>
    </div>

    <!-- Nuevo Modal de Factura de Entrega (retiro de múltiples componentes) -->
    <div id="delivery-invoice-modal" class="modal">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-xl sm:max-w-2xl">
            <h3 class="text-xl sm:text-2xl font-bold text-blue-800 mb-4 border-b pb-2">Crear Factura de Entrega</h3>
            
            <div class="mb-4">
                <label for="delivery-responsible" class="block text-sm font-medium text-gray-700 mb-1">Responsable de la Entrega:</label>
                <input type="text" id="delivery-responsible" value="Usuario de Entrega" class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="mb-4">
                <label for="delivery-search-input" class="block text-sm font-medium text-gray-700 mb-1">Buscar y Añadir Artículo:</label>
                <input type="text" id="delivery-search-input" placeholder="Buscar por Número de Parte o nombre..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <div id="delivery-search-results" class="hidden"></div> <!-- Resultados de búsqueda en vivo -->
            </div>

            <div class="overflow-x-auto mb-6 border rounded-lg">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700">Número de Parte</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700">Nombre</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700">Cantidad a Retirar</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700">Stock Disponible</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="delivery-items-list" class="divide-y divide-gray-200">
                        <!-- Items added to delivery will appear here -->
                    </tbody>
                </table>
            </div>

            <!-- Sección de Firmas -->
            <div class="mt-6 pt-4 border-t border-gray-300 grid grid-cols-2 lg:grid-cols-4 gap-4 text-center text-sm">
                <div class="signature-block">
                    <div class="h-12 sm:h-16 border-b border-gray-400 mb-2"></div>
                    <p class="text-xs sm:text-sm font-semibold text-gray-700">Jefe de Taller</p>
                </div>
                <div class="signature-block">
                    <div class="h-12 sm:h-16 border-b border-gray-400 mb-2"></div>
                    <p class="text-xs sm:text-sm font-semibold text-gray-700">Aprobado por A-4</p>
                </div>
                <div class="signature-block">
                    <div class="h-12 sm:h-16 border-b border-gray-400 mb-2"></div>
                    <p class="text-xs sm:text-sm font-semibold text-gray-700">Entregado por</p>
                </div>
                <div class="signature-block">
                    <div class="h-12 sm:h-16 border-b border-gray-400 mb-2"></div>
                    <p class="text-xs sm:text-sm font-semibold text-gray-700">Recibido por</p>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
                <button id="cancel-delivery-invoice-btn" class="py-2 px-4 border border-gray-300 shadow-sm text-sm sm:text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                    Cancelar
                </button>
                <button id="confirm-delivery-invoice-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm sm:text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                    <!-- Lucide check-circle icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle mr-1"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
                    Confirmar Entrega
                </button>
                <button id="print-delivery-invoice-btn" class="hidden inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm sm:text-base font-medium rounded-md text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 transition-colors duration-200">
                    <!-- Lucide printer icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer mr-1"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                    Imprimir Factura
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="custom-confirm-modal" class="modal">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-xs sm:max-w-sm text-center">
            <h3 id="custom-confirm-title" class="text-lg sm:text-xl font-bold text-gray-800 mb-4"></h3>
            <p id="custom-confirm-message" class="text-sm sm:text-base text-gray-700 mb-6"></p>
            <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4">
                <button id="custom-confirm-cancel" class="py-2 px-4 border border-gray-300 shadow-sm text-sm sm:text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                    Cancelar
                </button>
                <button id="confirm-confirm-ok" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm sm:text-base font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Nuevo Modal de Edición de Artículo -->
    <div id="edit-item-modal" class="modal">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-md sm:max-w-lg">
            <h3 class="text-xl sm:text-2xl font-bold text-blue-800 mb-4 border-b pb-2">Editar Artículo de Inventario</h3>
            <form id="edit-item-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                <!-- Hidden input for the item's Firebase Realtime Database key -->
                <input type="hidden" id="edit-db-key">

                <div>
                    <label for="edit-item-id" class="block text-sm font-medium text-gray-700 mb-1">Número de Parte del Artículo:</label>
                    <input type="text" id="edit-item-id" name="itemId" required class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="edit-item-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Artículo:</label>
                    <input type="text" id="edit-item-name" name="itemName" required class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="edit-item-category" class="block text-sm font-medium text-gray-700 mb-1">Categoría:</label>
                    <input type="text" id="edit-item-category" name="itemCategory" required class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="edit-item-quantity" class="block text-sm font-medium text-gray-700 mb-1">Cantidad:</label>
                    <input type="number" id="edit-item-quantity" name="itemQuantity" min="0" required class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="edit-item-unit" class="block text-sm font-medium text-gray-700 mb-1">Unidad de Medida:</label>
                    <select id="edit-item-unit" name="itemUnit" required class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Seleccione una unidad</option>
                        <option value="unidades">Unidades</option>
                        <option value="litros">Litros</option>
                        <option value="kilogramos">Kilogramos</option>
                        <option value="metros">Metros</option>
                        <option value="cajas">Cajas</option>
                        <option value="paquetes">Paquetes</option>
                        <option value="piezas">Piezas</option>
                        <option value="galones">Galones</option>
                        <option value="pares">Pares</option>
                        <option value="juegos">Juegos</option>
                    </select>
                </div>

                <div>
                    <label for="edit-item-location" class="block text-sm font-medium text-gray-700 mb-1">Ubicación (Ej. Estante A1, Pasillo 2):</label>
                    <input type="text" id="edit-item-location" name="itemLocation" required class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="edit-item-min-stock" class="block text-sm font-medium text-gray-700 mb-1">Stock Mínimo:</label>
                    <input type="number" id="edit-item-min-stock" name="itemMinStock" min="0" required class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="md:col-span-2 flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 mt-4 sm:mt-6">
                    <button type="button" id="cancel-edit-item-btn" class="py-2 px-4 border border-gray-300 shadow-sm text-sm sm:text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm sm:text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW: Modal for Image URL/Camera Search -->
    <div id="image-search-modal" class="modal">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-sm md:max-w-xl">
            <h3 class="text-xl sm:text-2xl font-bold text-blue-800 mb-4 border-b pb-2">Buscar por Imagen</h3>
            
            <!-- Option selection buttons -->
            <div id="image-search-options" class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4 mb-4 sm:mb-6">
                <button id="open-url-search-option-btn" class="py-2 px-4 border border-blue-600 text-blue-600 rounded-md hover:bg-blue-50 transition-colors duration-200 flex-1 text-sm">
                    Buscar por URL de Imagen
                </button>
                <button id="open-camera-search-option-btn" class="py-2 px-4 border border-purple-600 text-purple-600 rounded-md hover:bg-purple-50 transition-colors duration-200 flex-1 text-sm">
                    Buscar por Cámara
                </button>
            </div>

            <!-- Content for URL Search -->
            <div id="url-search-content" class="mb-4">
                <p class="text-gray-700 mb-4 text-sm">Pega la URL de una imagen para realizar una búsqueda inversa en Google Lens.</p>
                <div>
                    <label for="image-url-input" class="block text-sm font-medium text-gray-700 mb-1">URL de la Imagen:</label>
                    <input type="url" id="image-url-input" placeholder="Ej: https://ejemplo.com/imagen.jpg" class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 mt-4 sm:mt-6">
                    <button id="cancel-image-search-url-btn" class="py-2 px-4 border border-gray-300 shadow-sm text-sm sm:text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                        Cancelar
                    </button>
                    <button id="confirm-image-search-url-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm sm:text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                        Buscar Imagen
                    </button>
                </div>
            </div>

            <!-- Content for Camera Search (initially hidden) -->
            <div id="camera-search-content" class="hidden">
                <p class="text-gray-700 mb-4 text-sm">Asegúrate de que la iluminación sea buena y el artículo esté claro en la imagen.</p>
                <div id="camera-feed-container" class="relative bg-gray-200 flex justify-center items-center overflow-hidden mb-4 rounded-lg">
                    <video id="camera-feed" class="w-full h-auto rounded-lg" autoplay playsinline style="display: block;"></video>
                    <canvas id="camera-canvas" class="w-full h-auto rounded-lg hidden" style="display: none;"></canvas>
                    <img id="captured-image-preview" src="" alt="Captured Image" class="w-full h-auto rounded-lg hidden">
                </div>
                
                <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4 mb-4" id="camera-controls">
                    <button id="capture-image-btn" class="py-2 px-4 border border-transparent shadow-sm text-sm sm:text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                        Capturar Foto
                    </button>
                    <button id="retake-image-btn" class="py-2 px-4 border border-gray-300 shadow-sm text-sm sm:text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 hidden">
                        Volver a Tomar
                    </button>
                    <button id="download-image-btn" class="py-2 px-4 border border-blue-600 text-blue-600 rounded-md hover:bg-blue-50 transition-colors duration-200 hidden text-sm">
                        Descargar Imagen
                    </button>
                </div>

                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="cancel-image-search-camera-btn" class="py-2 px-4 border border-gray-300 shadow-sm text-sm sm:text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                        Cancelar
                    </button>
                    <button id="search-captured-image-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm sm:text-base font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors duration-200 hidden">
                        Buscar Imagen Capturada
                    </button>
                </div>
                <p id="camera-search-hint" class="text-xs text-gray-500 mt-2 text-center hidden">
                    Nota: Primero descarga la imagen, luego haz clic en "Buscar Imagen Capturada" y sube el archivo descargado en Google Lens.
                </p>
            </div>
        </div>
    </div>

    <!-- NEW: Modal for Item History -->
    <div id="item-history-modal" class="modal">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-xl sm:max-w-3xl">
            <h3 class="text-xl sm:text-2xl font-bold text-blue-800 mb-4 border-b pb-2">Historial de Movimientos para: <span id="history-item-name" class="text-blue-600"></span></h3>
            <div class="overflow-x-auto rounded-lg shadow-md mb-4">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider rounded-tl-lg">Fecha/Hora</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo Movimiento</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Cantidad</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fuente/Destino</th>
                            <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider rounded-tr-lg">Responsable</th>
                        </tr>
                    </thead>
                    <tbody id="specific-item-history-list" class="divide-y divide-gray-200">
                        <!-- History entries for the specific item will be loaded here -->
                    </tbody>
                </table>
                <p id="no-specific-history-items" class="text-gray-600 text-center py-4 hidden text-sm">No hay historial de movimientos para este artículo.</p>
            </div>
            <div class="flex justify-end">
                <button id="close-item-history-btn" class="py-2 px-4 border border-gray-300 shadow-sm text-sm sm:text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                    Cerrar
                </button>
            </div>
        </div>
    </div>


    <header class="bg-gradient-to-r from-blue-700 to-blue-900 text-white p-4 sm:p-6 shadow-md rounded-b-lg relative">
        <div class="container mx-auto text-center flex flex-col items-center justify-center">
            <!-- New Logo (left) -->
            <img src="https://placehold.co/100x100/blue/white?text=LOGO_IZQUIERDA" onerror="this.onerror=null; this.src='https://placehold.co/100x100/blue/white?text=LOGO_ERROR_LEFT'" alt="Escudo de Honduras" class="absolute left-2 top-2 sm:left-6 sm:top-6 h-16 w-16 sm:h-24 sm:w-24 object-contain rounded-full shadow-lg">
            
            <h1 class="text-2xl sm:text-4xl font-bold mb-1 sm:mb-2">Sistema de Gestión de Inventario Logístico A-4 HAM</h1>
            <!-- Adjusted for proper positioning and custom font -->
            <p class="created-by-text text-xs sm:text-sm">CREADO POR EL COMANDO 2 HERNANDEZ SOZA EL 16-JUN-25</p>
            
            <!-- Original Logo (right) -->
            <img src="https://placehold.co/100x100/blue/white?text=LOGO_DERECHA" onerror="this.onerror=null; this.src='https://placehold.co/100x100/blue/white?text=LOGO_ERROR_RIGHT'" alt="Logo de la Fuerza Aérea Hondureña" class="absolute right-2 top-2 sm:right-6 sm:top-6 h-16 w-16 sm:h-24 sm:w-24 object-contain rounded-full shadow-lg">
        </div>
    </header>

    <nav class="bg-blue-800 text-white p-3 shadow-sm rounded-t-lg mt-4 mx-auto w-11/12 md:w-4/5 lg:w-3/4">
        <div class="container mx-auto flex flex-wrap justify-center space-x-2 sm:space-x-4 text-sm sm:text-base">
            <a href="#vision-general" class="hover:underline py-1 px-2 sm:px-3 rounded-md hover:bg-blue-700 transition-colors duration-200 whitespace-nowrap">Visión General</a>
            <a href="#inventario-actual" class="hover:underline py-1 px-2 sm:px-3 rounded-md hover:bg-blue-700 transition-colors duration-200 whitespace-nowrap">Inventario Actual</a>
            <a href="#analisis-inventario" class="hover:underline py-1 px-2 sm:px-3 rounded-md hover:bg-blue-700 transition-colors duration-200 whitespace-nowrap">Análisis del Inventario</a>
            <a href="#historial-movimientos" class="hover:underline py-1 px-2 sm:px-3 rounded-md hover:bg-blue-700 transition-colors duration-200 whitespace-nowrap">Historial de Movimientos</a>
            <a href="#historial-facturas" class="hover:underline py-1 px-2 sm:px-3 rounded-md hover:bg-blue-700 transition-colors duration-200 whitespace-nowrap">Historial de Facturas</a>
            <a href="#ordenes-reabastecimiento" class="hover:underline py-1 px-2 sm:px-3 rounded-md hover:bg-blue-700 transition-colors duration-200 whitespace-nowrap">Órdenes de Reabastecimiento</a>
            <a href="#anadir-articulo" class="hover:underline py-1 px-2 sm:px-3 rounded-md hover:bg-blue-700 transition-colors duration-200 whitespace-nowrap">Añadir Artículo</a>
        </div>
    </nav>

    <main class="container mx-auto p-4 sm:p-6 bg-white shadow-xl rounded-lg mt-4 sm:mt-6 mb-6 sm:mb-8 w-11/12 md:w-4/5 lg:w-3/4">
        <!-- Authentication Section -->
        <section id="auth-section" class="mb-6 sm:mb-8 p-4 sm:p-6 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-2xl sm:text-3xl font-semibold text-blue-800 mb-3 sm:mb-4 border-b-2 border-blue-300 pb-2">Acceso de Usuario</h2>
            <div id="logged-out-view">
                <p class="text-sm sm:text-lg text-gray-700 mb-3 sm:mb-4">Inicia sesión o regístrate para acceder y gestionar tu inventario persistente en cualquier dispositivo.</p>
                <div class="flex flex-col space-y-3 items-center">
                    <input type="email" id="auth-email" placeholder="Correo electrónico" class="w-full max-w-sm px-3 py-2 text-sm border rounded-md">
                    <input type="password" id="auth-password" placeholder="Contraseña" class="w-full max-w-sm px-3 py-2 text-sm border rounded-md">
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                        <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 text-sm">Iniciar Sesión</button>
                        <button id="register-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 text-sm">Registrarse</button>
                    </div>
                </div>
            </div>
            <div id="logged-in-view" class="hidden text-center">
                <p class="text-sm sm:text-lg text-gray-700 mb-3 sm:mb-4">Has iniciado sesión como: <span id="current-user-email" class="font-semibold text-blue-700"></span></p>
                <button id="logout-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 text-sm">Cerrar Sesión</button>
            </div>
        </section>

        <!-- Sección de Visión General (Now visible by default) -->
        <section id="vision-general" class="mb-6 sm:mb-8 p-4 sm:p-6 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-2xl sm:text-3xl font-semibold text-blue-800 mb-3 sm:mb-4 border-b-2 border-blue-300 pb-2">Visión General del Inventario</h2>
            <p class="text-sm sm:text-lg text-gray-700 leading-relaxed mb-3 sm:mb-4">Este sistema permite una gestión detallada y eficiente de todos los componentes, partes, herramientas y otros materiales necesarios para tus operaciones. Mantén un control preciso sobre las existencias, optimiza los flujos de trabajo y minimiza los costos de almacenamiento.</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6 text-center">
                <div class="bg-white p-3 sm:p-4 rounded-lg shadow-md border border-gray-200">
                    <p class="text-xs sm:text-sm text-gray-500">Artículos en stock</p>
                    <p id="total-items" class="text-3xl sm:text-4xl font-bold text-green-600">0</p>
                </div>
                <div class="bg-white p-3 sm:p-4 rounded-lg shadow-md border border-gray-200">
                    <p class="text-xs sm:text-sm text-gray-500">Total de Stock</p>
                    <p id="total-stock" class="text-3xl sm:text-4xl font-bold text-blue-600">0</p>
                </div>
                <div id="critical-items-card" class="bg-white p-3 sm:p-4 rounded-lg shadow-md border border-gray-200 cursor-pointer hover:bg-red-50 transition-colors duration-200">
                    <p class="text-xs sm:text-sm text-gray-500">Artículos críticos (bajo stock)</p>
                    <p id="critical-items" class="text-3xl sm:text-4xl font-bold text-red-600">0</p>
                </div>
                <div class="bg-white p-3 sm:p-4 rounded-lg shadow-md border border-gray-200">
                    <p class="text-xs sm:text-sm text-gray-500">Última actualización</p>
                    <p id="last-update" class="text-sm sm:text-lg font-medium text-gray-700"></p>
                </div>
            </div>
        </section>

        <hr class="my-6 sm:my-8 border-gray-300 main-content-divider">

        <!-- Sección de Inventario Actual (Now visible by default) -->
        <section id="inventario-actual" class="mb-6 sm:mb-8 p-4 sm:p-6 bg-gray-50 rounded-lg shadow-inner">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-3 sm:mb-4 border-b-2 border-blue-300 pb-2">
                <h2 class="text-2xl sm:text-3xl font-semibold text-blue-800 mb-2 sm:mb-0">Inventario Actual de Componentes y Partes</h2>
                <button id="toggle-inventory-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-md transition-colors duration-200 flex items-center text-sm">
                    Desplegar/Plegar
                    <!-- Lucide chevron-down icon for toggle -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down ml-2 chevron-icon"></svg>
                </button>
            </div>
            
            <div id="inventory-content" class="collapsible-content">
                <!-- Barra de búsqueda y botones de acción -->
                <div class="flex flex-col md:flex-row items-center justify-between mb-4 sm:mb-6 space-y-3 md:space-y-0 md:space-x-4">
                    <div class="flex w-full md:w-auto flex-grow space-x-2">
                        <input type="text" id="search-input" placeholder="Buscar por Número de Parte, nombre, categoría..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <button id="search-button" class="inline-flex justify-center py-2 px-3 text-sm border border-transparent shadow-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                            <!-- Lucide refresh-cw icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw mr-1"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                            Todo
                        </button>
                        <!-- Button to open Image Search Modal -->
                        <button id="open-image-search-modal-btn" class="inline-flex justify-center py-2 px-3 text-sm border border-transparent shadow-sm font-medium rounded-md text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors duration-200 whitespace-nowrap">
                            <!-- Lucide image icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image mr-1">
                                <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                                <circle cx="9" cy="9" r="2"/>
                                <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                            </svg>
                            Buscar por Imagen
                        </button>
                    </div>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-3 md:mt-0">
                        <button id="print-inventory-btn" class="inline-flex justify-center py-2 px-3 text-sm border border-transparent shadow-sm font-medium rounded-md text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 transition-colors duration-200 whitespace-nowrap">
                            <!-- Lucide printer icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer mr-1"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                            Imprimir Inventario
                        </button>
                        <button id="open-delivery-invoice-modal-btn" class="inline-flex justify-center py-2 px-3 text-sm border border-transparent shadow-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors duration-200 whitespace-nowrap">
                            <!-- Lucide file-text icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text mr-1"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                            Crear Factura de Entrega
                        </button>
                    </div>
                </div>

                <!-- Contenedor con barra de desplazamiento -->
                <div id="inventory-table-container">
                    <table class="min-w-full bg-white border border-gray-200">
                        <thead class="bg-gray-200 sticky top-0"> <!-- Sticky header -->
                            <tr>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider rounded-tl-lg">Número de Parte</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Nombre del Artículo</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Imagen</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Categoría</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Cantidad</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Unidad</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Ubicación</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Stock Mínimo</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider rounded-tr-lg">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-list" class="divide-y divide-gray-200">
                            <!-- Los datos se cargarán desde Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <hr class="my-6 sm:my-8 border-gray-300 main-content-divider">

        <!-- Nueva Sección: Análisis del Inventario (Gráficos) -->
        <section id="analisis-inventario" class="mb-6 sm:mb-8 p-4 sm:p-6 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-2xl sm:text-3xl font-semibold text-blue-800 mb-3 sm:mb-4 border-b-2 border-blue-300 pb-2">Análisis del Inventario</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                <div>
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-700 mb-2 sm:mb-3">Inventario por Categoría</h3>
                    <canvas id="inventoryByCategoryChart"></canvas>
                </div>
                <!-- You can add more charts here -->
            </div>
        </section>

        <hr class="my-6 sm:my-8 border-gray-300 main-content-divider">

        <!-- Sección de Historial de Movimientos -->
        <section id="historial-movimientos" class="mb-6 sm:mb-8 p-4 sm:p-6 bg-gray-50 rounded-lg shadow-inner">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-3 sm:mb-4 border-b-2 border-blue-300 pb-2">
                <h2 class="text-2xl sm:text-3xl font-semibold text-blue-800 mb-2 sm:mb-0">Historial de Movimientos Recientes</h2>
                <button id="toggle-history-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-md transition-colors duration-200 flex items-center text-sm">
                    Desplegar/Plegar
                    <!-- Lucide chevron-down icon for toggle -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down ml-2 chevron-icon"></svg>
                </button>
            </div>
            
            <div id="history-content" class="collapsible-content">
                <div class="flex justify-end mb-4 space-x-2">
                    <button id="clear-history-btn" class="inline-flex justify-center py-2 px-3 text-sm border border-transparent shadow-sm font-medium rounded-md text-white bg-red-700 hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-600 transition-colors duration-200">
                        <!-- Lucide trash icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash mr-1"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        Borrar Historial
                    </button>
                </div>
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full bg-white border border-gray-200">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider rounded-tl-lg">Fecha/Hora</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Número de Parte</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Nombre Artículo</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo Movimiento</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Cantidad</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fuente/Destino</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider rounded-tr-lg">Responsable</th>
                            </tr>
                        </thead>
                        <tbody id="movement-history-list" class="divide-y divide-gray-200">
                            <!-- Las entradas se cargarán desde Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <hr class="my-6 sm:my-8 border-gray-300 main-content-divider">

        <!-- Nueva Sección: Historial de Facturas -->
        <section id="historial-facturas" class="mb-6 sm:mb-8 p-4 sm:p-6 bg-gray-50 rounded-lg shadow-inner">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-3 sm:mb-4 border-b-2 border-blue-300 pb-2">
                <h2 class="text-2xl sm:text-3xl font-semibold text-blue-800 mb-2 sm:mb-0">Historial de Facturas de Entrega</h2>
                <button id="toggle-invoice-history-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-md transition-colors duration-200 flex items-center text-sm">
                    Desplegar/Plegar
                    <!-- Lucide chevron-down icon for toggle -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down ml-2 chevron-icon"></svg>
                </button>
            </div>
            
            <div id="invoice-history-content" class="collapsible-content">
                <div class="flex justify-end mb-4 space-x-2">
                    <button id="clear-invoice-history-btn" class="inline-flex justify-center py-2 px-3 text-sm border border-transparent shadow-sm font-medium rounded-md text-white bg-red-700 hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-600 transition-colors duration-200">
                        <!-- Lucide trash icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash mr-1"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        Borrar Historial de Facturas
                    </button>
                </div>
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full bg-white border border-gray-200">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider rounded-tl-lg">Número de Factura</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha/Hora</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Responsable</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Artículos</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider rounded-tr-lg">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-history-list" class="divide-y divide-gray-200">
                            <!-- Las entradas de facturas se cargarán aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <hr class="my-6 sm:my-8 border-gray-300 main-content-divider">

        <!-- Nueva Sección: Artículos para Reabastecer (Sugerencias) -->
        <section id="ordenes-reabastecimiento" class="mb-6 sm:mb-8 p-4 sm:p-6 bg-gray-50 rounded-lg shadow-inner">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-3 sm:mb-4 border-b-2 border-blue-300 pb-2">
                <h2 class="text-2xl sm:text-3xl font-semibold text-blue-800 mb-2 sm:mb-0">Artículos para Reabastecer</h2>
                <button id="toggle-reorder-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-md transition-colors duration-200 flex items-center text-sm">
                    Desplegar/Plegar
                    <!-- Lucide chevron-down icon for toggle -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down ml-2 chevron-icon"></svg>
                </button>
            </div>
            
            <div id="reorder-content" class="collapsible-content">
                <p class="text-sm sm:text-lg text-gray-700 leading-relaxed mb-3 sm:mb-4">Los siguientes artículos están en o por debajo de su stock mínimo y pueden requerir reabastecimiento.</p>
                <div class="flex justify-end mb-4 space-x-2">
                    <button id="print-reorder-btn" class="inline-flex justify-center py-2 px-3 text-sm border border-transparent shadow-sm font-medium rounded-md text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 transition-colors duration-200 whitespace-nowrap">
                        <!-- Lucide printer icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer mr-1"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                        Imprimir Sugerencias
                    </button>
                </div>
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full bg-white border border-gray-200">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider rounded-tl-lg">Número de Parte</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Nombre del Artículo</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Cantidad Actual</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Stock Mínimo</th>
                                <th class="py-2 px-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider rounded-tr-lg">Cantidad Sugerida</th>
                            </tr>
                        </thead>
                        <tbody id="reorder-list" class="divide-y divide-gray-200">
                            <!-- Los artículos para reabastecer se cargarán aquí -->
                        </tbody>
                    </table>
                    <p id="no-reorder-items" class="text-gray-600 text-center py-4 hidden text-sm">No hay artículos que requieran reabastecimiento en este momento. ¡Buen trabajo!</p>
                </div>
            </div>
        </section>

        <hr class="my-6 sm:my-8 border-gray-300 main-content-divider">

        <!-- Sección para Añadir Nuevo Artículo (Now visible by default) -->
        <section id="anadir-articulo" class="p-4 sm:p-6 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-2xl sm:text-3xl font-semibold text-blue-800 mb-3 sm:mb-4 border-b-2 border-blue-300 pb-2">Añadir Nuevo Artículo al Inventario</h2>
            <form id="add-item-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                <div>
                    <label for="item-id" class="block text-sm font-medium text-gray-700 mb-1">Número de Parte del Artículo:</label>
                    <input type="text" id="item-id" name="itemId" required class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="item-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Artículo:</label>
                    <input type="text" id="item-name" name="itemName" required class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="item-category" class="block text-sm font-medium text-gray-700 mb-1">Categoría:</label>
                    <input type="text" id="item-category" name="itemCategory" required class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="item-quantity" class="block text-sm font-medium text-gray-700 mb-1">Cantidad:</label>
                    <input type="number" id="item-quantity" name="itemQuantity" min="0" required class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="item-unit" class="block text-sm font-medium text-gray-700 mb-1">Unidad de Medida:</label>
                    <select id="item-unit" name="itemUnit" required class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Seleccione una unidad</option>
                        <option value="unidades">Unidades</option>
                        <option value="litros">Litros</option>
                        <option value="kilogramos">Kilogramos</option>
                        <option value="metros">Metros</option>
                        <option value="cajas">Cajas</option>
                        <option value="paquetes">Paquetes</option>
                        <option value="piezas">Piezas</option>
                        <option value="galones">Galones</option>
                        <option value="pares">Pares</option>
                        <option value="juegos">Juegos</option>
                    </select>
                </div>

                <!-- Modificación aquí: Campo de texto para ubicación -->
                <div>
                    <label for="item-location" class="block text-sm font-medium text-gray-700 mb-1">Ubicación (Ej. Estante A1, Pasillo 2):</label>
                    <input type="text" id="item-location" name="itemLocation" required class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="item-min-stock" class="block text-sm font-medium text-gray-700 mb-1">Stock Mínimo:</label>
                    <input type="number" id="item-min-stock" name="itemMinStock" min="0" required class="mt-1 block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="md:col-span-2 text-center mt-4">
                    <button type="submit" class="inline-flex justify-center py-2.5 px-5 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200 transform hover:scale-105">
                        <!-- Lucide plus icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus mr-2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                        Añadir Artículo
                    </button>
                </div>
            </form>
        </section>

    </main>

    <footer class="bg-gray-800 text-white p-4 sm:p-6 text-center rounded-t-lg mt-6 sm:mt-8 shadow-inner">
        <p class="text-xs sm:text-sm">
            &copy; 2025 Sistema de Logística de Inventario. Todos los derechos reservados.
            <br>
            <span id="user-id-display"></span>
        </p>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        // UPDATED FIREBASE CDNs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";


        // Global variables for Firebase instances and user data
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous
        let currentUserIdentifier = 'Anónimo'; // New: Stores email or uid, or 'Anónimo'
        let inventoryRef; // Reference for Realtime Database
        let historyRef; // Reference for movement history
        let invoiceHistoryRef; // Reference for invoice history
        let isAuthReady = false; // Flag to indicate Firebase auth is ready
        let currentInventoryItems = []; // To store a local copy of inventory for live search
        let allMovementHistory = []; // To store a local copy of all movement history for detailed view
        let initialDataLoadedCount = 0; // New: Counter for initial loads
        const expectedInitialLoads = 3; // Number of onValue listeners to wait for

        // Chart.js global variable
        let inventoryByCategoryChartInstance = null;
        let reorderItemsToPrint = []; // New: To store items for reorder suggestions printout

        // Camera and Image search variables
        let cameraStream = null;
        let capturedImageDataUrl = null; // Store data URL of captured image

        // Direct Firebase configuration (fallback)
        const localFirebaseConfig = {
            apiKey: "AIzaSyDMmICpFCInGwg74YK-5bPKvM4kk5nUJpw",
            authDomain: "abastos-bb76a.firebaseapp.com",
            databaseURL: "https://abastos-bb76a-default-rtdb.firebaseio.com",
            projectId: "abastos-bb76a",
            storageBucket: "abastos-bb76a.appspot.com",
            messagingSenderId: "708455293960",
            appId: "1:708455293960:web:144e21229865e7f25f9dbd",
            measurementId: "G-BZT4HZZ857"
        };

        // PRIORITIZE: Use __firebase_config if available, otherwise use localFirebaseConfig
        let firebaseConfig;
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : localFirebaseConfig;
            if (!firebaseConfig) {
                console.error("Firebase config is not available from __firebase_config and local fallback is also missing or invalid. Please ensure the Canvas environment provides it or hardcode a valid config.");
                showMessage("Error: Configuración de Firebase no encontrada. La aplicación no persistirá datos.", true);
            }
        } catch (e) {
            console.error("Error parsing __firebase_config, falling back to local config:", e);
            firebaseConfig = localFirebaseConfig; // Fallback in case of parsing error
            showMessage("Advertencia: Error al cargar la configuración de Firebase. Usando configuración local.", false); // Use false for warning
        }

        // Check if __app_id is defined by the environment (used for collection paths specific to Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Note: __initial_auth_token is primarily for initial anonymous sign-in in Canvas.
        // For cross-device persistence, explicit user authentication (email/password) is needed.
        // const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Function to show custom message box
        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.classList.remove('bg-green-600', 'bg-red-600', 'error');
            if (isError) {
                messageBox.classList.add('bg-red-600', 'error');
            } else {
                messageBox.classList.add('bg-green-600');
            }
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        // New: Function to hide the loading overlay
        function hideLoadingOverlay() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay.style.display !== 'none') {
                loadingOverlay.style.display = 'none';
                console.log("Loading overlay hidden.");
            }
        }

        // Function to update the last update time on the UI
        function updateLastUpdateTime() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('last-update').textContent = now.toLocaleDateString('es-ES', options);
        }

        // Function to get formatted date and time for history
        function getFormattedDateTime() {
            const now = new Date();
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            return now.toLocaleDateString('es-ES', options).replace(/\//g, '-') + ' ' + now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        }

        // Function to add a movement entry to Realtime Database
        async function addMovementToHistory(itemId, itemName, movementType, quantity, sourceDestination, responsible) {
            if (!isAuthReady) {
                console.warn("Realtime Database no está lista, no se puede añadir entrada al historial de movimientos.");
                return;
            }
            try {
                // Use push() to generate a unique key for each history entry
                await push(historyRef, {
                    timestamp: new Date().toISOString(), // Store as ISO string for RTDB
                    itemId,
                    itemName,
                    movementType,
                    quantity,
                    sourceDestination,
                    responsible: responsible || currentUserIdentifier // Use provided responsible or default to currentUserIdentifier
                });
                console.log(`Movimiento de historial añadido para ${itemName}.`);
            } catch (e) {
                console.error("Error al añadir documento al historial de movimientos en Realtime Database: ", e);
                showMessage("Error al guardar en el historial de movimientos.", true);
            }
        }

        // Custom Confirmation Modal Logic
        let confirmResolver = null;

        function showConfirm(title, message) {
            return new Promise((resolve) => {
                confirmResolver = resolve;
                const confirmModal = document.getElementById('custom-confirm-modal');
                const confirmTitle = document.getElementById('custom-confirm-title');
                const confirmMessage = document.getElementById('custom-confirm-message');
                
                if (confirmModal && confirmTitle && confirmMessage) { // Defensive check
                    confirmTitle.textContent = title;
                    confirmMessage.textContent = message;
                    confirmModal.classList.add('flex');
                } else {
                    console.error("No se encontraron elementos del modal de confirmación. Asegúrese de que existen en el DOM.");
                    resolve(false); // Resolve false if modal elements are missing
                }
            });
        }

        // Función para abrir el modal de edición de artículo y precargar datos
        function openEditItemModal(dbKey, itemId, itemName, itemCategory, itemQuantity, itemUnit, itemLocation, itemMinStock) {
            document.getElementById('edit-db-key').value = dbKey;
            document.getElementById('edit-item-id').value = itemId;
            document.getElementById('edit-item-name').value = itemName;
            document.getElementById('edit-item-category').value = itemCategory;
            document.getElementById('edit-item-quantity').value = itemQuantity;
            document.getElementById('edit-item-unit').value = itemUnit;
            document.getElementById('edit-item-location').value = itemLocation;
            document.getElementById('edit-item-min-stock').value = itemMinStock;

            document.getElementById('edit-item-modal').classList.add('flex');
        }

        // Función para cerrar el modal de edición
        function cancelEditItem() {
            document.getElementById('edit-item-modal').classList.remove('flex');
        }

        // Function to standardize and validate category input
        function standardizeAndValidateCategory(categoryInput) {
            let category = categoryInput.trim().toUpperCase();
            let originalCategory = category; // Store original for messages

            // 1. Standardize "NUEVA" to "NUEVO"
            if (category === 'NUEVA') {
                category = 'NUEVO';
            }

            // 2. Attempt simple plural to singular conversion for common patterns
            // This is a best-effort, based on common Spanish plural endings and exceptions.
            // For true natural language processing, a more complex solution is needed.
            const pluralToSingularMap = {
                'HERRAMIENTAS': 'HERRAMIENTA',
                'REPUESTOS': 'REPUESTO',
                'COMPONENTES': 'COMPONENTE',
                'UNIDADES': 'UNIDAD',
                'PIEZAS': 'PIEZA',
                'CAJAS': 'CAJA',
                'PAQUETES': 'PAQUETE',
                'PARES': 'PAR',
                'JUEGOS': 'JUEGO',
                'FILTROS': 'FILTRO',
                'LUBRICANTES': 'LUBRICANTE',
                'BATERIAS': 'BATERIA',
                'NEUMATICOS': 'NEUMATICO'
            };

            if (pluralToSingularMap[category]) {
                category = pluralToSingularMap[category];
                showMessage(`La categoría "${originalCategory}" ha sido estandarizada a "${category}". Por favor, intente usar siempre términos singulares.`, false);
            } else if (category.endsWith('ES') && category.length > 2) {
                // Generic rule for words ending in 'ES', avoiding common singular exceptions
                const exceptionsEndingES = ['LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'ANALISIS', 'CRISIS', 'SINTESIS'];
                if (!exceptionsEndingES.includes(category)) {
                    category = category.slice(0, -2);
                    showMessage(`La categoría "${originalCategory}" ha sido estandarizada a "${category}" (se removió 'ES'). Por favor, intente usar siempre términos singulares.`, false);
                }
            } else if (category.endsWith('S') && category.length > 1) {
                // Generic rule for words ending in 'S', avoiding common singular exceptions
                const exceptionsEndingS = ['ATLAS', 'PARAGUAS'];
                if (!exceptionsEndingS.includes(category)) {
                    category = category.slice(0, -1);
                    showMessage(`La categoría "${originalCategory}" ha sido estandarizada a "${category}" (se removió 'S'). Por favor, intente usar siempre términos singulares.`, false);
                }
            }
            // If the category was NUEVA and not caught by pluralization, still show message
            else if (originalCategory !== category) {
                 showMessage(`La categoría "${originalCategory}" ha sido estandarizada a "${category}".`, false);
            }
            
            return category;
        }


        // Función para confirmar y guardar los cambios del artículo editado
        async function confirmEditItem(event) {
            event.preventDefault(); // Prevent default form submission

            if (!isAuthReady) {
                showMessage("La base de datos no está lista. Intente de nuevo en unos segundos.", true);
                return;
            }

            const dbKey = document.getElementById('edit-db-key').value;
            // Convert to uppercase and standardize
            const newItemId = document.getElementById('edit-item-id').value.trim().toUpperCase();
            const newItemName = document.getElementById('edit-item-name').value.trim().toUpperCase();
            const newCategory = standardizeAndValidateCategory(document.getElementById('edit-item-category').value); // Use new standardization function
            const newQuantity = parseInt(document.getElementById('edit-item-quantity').value);
            const newUnit = document.getElementById('edit-item-unit').value;
            const newLocation = document.getElementById('edit-item-location').value.trim();
            const newMinStock = parseInt(document.getElementById('edit-item-min-stock').value);

            if (!newItemId || !newItemName || !newCategory || isNaN(newQuantity) || !newUnit || !newLocation || isNaN(newMinStock)) {
                showMessage('Por favor, complete todos los campos en el formulario de edición correctamente.', true);
                return;
            }
            if (newQuantity < 0 || newMinStock < 0) {
                 showMessage('La cantidad y el stock mínimo no pueden ser números negativos.', true);
                 return;
            }
            if (newUnit === "") {
                showMessage('Por favor, seleccione una unidad de medida para el artículo editado.', true);
                return;
            }

            try {
                // Point to public inventory
                const itemDbRef = ref(db, `artifacts/${appId}/public/data/inventory/${dbKey}`);
                await update(itemDbRef, {
                    itemId: newItemId,
                    name: newItemName,
                    category: newCategory,
                    quantity: newQuantity,
                    unit: newUnit,
                    location: newLocation,
                    minStock: newMinStock
                });

                // Get original item details for movement history (assuming we have them in currentInventoryItems)
                const originalItem = currentInventoryItems.find(item => item.id === dbKey);
                const oldQuantity = originalItem ? originalItem.quantity : 0;
                const quantityDifference = newQuantity - oldQuantity;
                let movementType = '';
                let movementQuantity = Math.abs(quantityDifference);

                if (quantityDifference > 0) {
                    movementType = 'Edición (Ingreso)';
                } else if (quantityDifference < 0) {
                    movementType = 'Edición (Retiro)';
                } else {
                    movementType = 'Edición (Sin cambio de cantidad)';
                    movementQuantity = 0; // No quantity change to log
                }
                
                // Only log if there was an actual change or if it's important to log all edits
                if (movementQuantity > 0 || movementType === 'Edición (Sin cambio de cantidad)') {
                    await addMovementToHistory(newItemId, newItemName, movementType, movementQuantity, 'Formulario de Edición', currentUserIdentifier);
                }
                
                console.log(`Artículo "${newItemName}" actualizado con éxito en Realtime Database.`);
                showMessage(`Artículo "${newItemName}" actualizado con éxito en Realtime Database.`, false);
                cancelEditItem(); // Close the modal
            } catch (e) {
                console.error("Error al actualizar el artículo en Realtime Database: ", e);
                showMessage("Error al guardar los cambios del artículo. Intente de nuevo.", true);
            }
        }

        /**
         * Function to open a Google Image search in a new tab for a given part number.
         * @param {string} partNumber The part number to search for.
         * @param {string} itemName The name of the item (for better search query).
         */
        async function searchImageInGoogle(partNumber, itemName) {
            // Show alert/message before opening the new tab
            const confirmed = await showConfirm(
                'Búsqueda de Imagen',
                `Se abrirá una nueva pestaña con la búsqueda de imágenes para "${partNumber} ${itemName}". Las imágenes mostradas son solo de referencia y pueden no ser exactas.`
            );

            if (!confirmed) {
                return; // User cancelled
            }

            // Encode the query to handle special characters correctly in the URL
            const searchQuery = encodeURIComponent(`${partNumber} ${itemName} component image`);
            const googleSearchUrl = `https://www.google.com/search?q=${searchQuery}&tbm=isch`;
            
            // Open the URL in a new tab
            window.open(googleSearchUrl, '_blank');
            showMessage(`Buscando imágenes de "${partNumber}" en Google...`, false);
        }

        /**
         * NEW: Function to perform a reverse image search on Google Lens using a URL.
         * @param {string} imageUrl The URL of the image to search for.
         */
        function reverseImageSearchGoogle(imageUrl) {
            const encodedImageUrl = encodeURIComponent(imageUrl);
            const googleLensUrl = `https://lens.google.com/uploadbyurl?url=${encodedImageUrl}`;
            window.open(googleLensUrl, '_blank');
            showMessage(`Realizando búsqueda inversa de imagen en Google Lens...`, false);
        }

        /**
         * NEW: Functions for Camera Image Search
         */
        const cameraFeed = document.getElementById('camera-feed');
        const cameraCanvas = document.getElementById('camera-canvas');
        const cameraCtx = cameraCanvas.getContext('2d');
        const capturedImagePreview = document.getElementById('captured-image-preview');
        const captureImageBtn = document.getElementById('capture-image-btn');
        const retakeImageBtn = document.getElementById('retake-image-btn');
        const downloadImageBtn = document.getElementById('download-image-btn'); // NEW: Download button
        const searchCapturedImageBtn = document.getElementById('search-captured-image-btn');
        const cameraSearchHint = document.getElementById('camera-search-hint');

        async function startCamera() {
            stopCamera(); // Stop any existing stream first
            cameraFeed.style.display = 'block';
            cameraCanvas.style.display = 'none';
            capturedImagePreview.style.display = 'none';
            captureImageBtn.classList.remove('hidden');
            retakeImageBtn.classList.add('hidden');
            downloadImageBtn.classList.add('hidden'); // Hide download button initially
            searchCapturedImageBtn.classList.add('hidden');
            cameraSearchHint.classList.add('hidden');

            try {
                // Request access to the rear camera if available, otherwise default camera
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                cameraFeed.srcObject = cameraStream;
                showMessage("Cámara iniciada. Apunte al artículo y capture la foto.", false);
            } catch (err) {
                console.error("Error al acceder a la cámara:", err);
                showMessage("Error al acceder a la cámara. Asegúrese de que ha dado permisos y de que su dispositivo tiene cámara. " + err.message, true);
                // Fallback or disable camera features if no camera
                document.getElementById('open-camera-search-option-btn').disabled = true;
                document.getElementById('open-camera-search-option-btn').textContent = "Cámara no disponible";
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }

        function captureImage() {
            if (!cameraStream) {
                showMessage("No hay una cámara activa para capturar la imagen.", true);
                return;
            }

            // Set canvas dimensions to match video stream
            cameraCanvas.width = cameraFeed.videoWidth;
            cameraCanvas.height = cameraFeed.videoHeight;
            cameraCtx.drawImage(cameraFeed, 0, 0, cameraCanvas.width, cameraCanvas.height);
            
            capturedImageDataUrl = cameraCanvas.toDataURL('image/png'); // Get image as data URL
            capturedImagePreview.src = capturedImageDataUrl;

            // Stop camera stream after capturing
            stopCamera(); 

            cameraFeed.style.display = 'none';
            cameraCanvas.style.display = 'none'; // Hide canvas used for drawing
            capturedImagePreview.style.display = 'block'; // Show captured image
            captureImageBtn.classList.add('hidden');
            retakeImageBtn.classList.remove('hidden');
            downloadImageBtn.classList.remove('hidden'); // Show download button
            searchCapturedImageBtn.classList.remove('hidden');
            cameraSearchHint.classList.remove('hidden');
            showMessage("Imagen capturada. Puedes descargarla o volver a tomarla.", false);
        }

        // NEW: Function to download the captured image
        function downloadCapturedImage() {
            if (!capturedImageDataUrl) {
                showMessage("No hay imagen capturada para descargar.", true);
                return;
            }
            const a = document.createElement('a');
            a.href = capturedImageDataUrl;
            a.download = `imagen_capturada_${Date.now()}.png`;
            document.body.appendChild(a); // Append to body to make it clickable
            a.click(); // Programmatically click the link
            document.body.removeChild(a); // Remove the link after clicking
            showMessage("Imagen descargada con éxito.", false);
        }


        function searchCapturedImage() {
            if (!capturedImageDataUrl) {
                showMessage("Primero, captura una imagen para buscar.", true);
                return;
            }

            showMessage("Abriendo Google Lens. Por favor, sube la imagen que acabas de descargar.", false);

            // Open Google Lens in a new tab
            window.open('https://lens.google.com/', '_blank');
        }

        // --- NEW: Item History Modals (Improvement 6) ---
        function openItemHistoryModal(itemId, itemName) {
            document.getElementById('history-item-name').textContent = `${itemName} (${itemId})`;
            const specificItemHistoryList = document.getElementById('specific-item-history-list');
            specificItemHistoryList.innerHTML = ''; // Clear previous entries

            const filteredHistory = allMovementHistory.filter(move => move.itemId === itemId);

            if (filteredHistory.length === 0) {
                document.getElementById('no-specific-history-items').classList.remove('hidden');
            } else {
                document.getElementById('no-specific-history-items').classList.add('hidden');
                // Sort movements by timestamp in descending order (most recent first)
                filteredHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                filteredHistory.forEach(move => {
                    const newRow = specificItemHistoryList.insertRow();
                    newRow.classList.add('hover:bg-gray-50');

                    newRow.insertCell().textContent = new Date(move.timestamp).toLocaleString('es-ES', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                    }).replace(/\//g, '-');
                    newRow.insertCell().textContent = move.movementType;
                    newRow.insertCell().textContent = move.quantity;
                    newRow.insertCell().textContent = move.sourceDestination;
                    newRow.insertCell().textContent = move.responsible;
                });
            }
            document.getElementById('item-history-modal').classList.add('flex');
        }

        function closeItemHistoryModal() {
            document.getElementById('item-history-modal').classList.remove('flex');
        }


        // Function to render inventory items to the table
        function renderInventory(items) {
            const tableBody = document.getElementById('inventory-list');
            tableBody.innerHTML = ''; // Clear current table
            currentInventoryItems = items; // Update local copy for live search

            let totalItemsCount = 0;
            let criticalItemsCount = 0;
            let totalStockQuantity = 0; // New: Initialize total stock quantity

            items.forEach(item => {
                totalItemsCount++; // Count distinct items
                totalStockQuantity += item.quantity; // Sum all quantities for total stock quantity

                if (item.quantity <= item.minStock) {
                    criticalItemsCount++;
                }

                const newRow = tableBody.insertRow();
                newRow.classList.add('hover:bg-gray-50');
                // Store Realtime Database key in the row for easy access
                newRow.dataset.dbKey = item.id; 

                newRow.insertCell().textContent = item.itemId; // Custom item ID
                newRow.insertCell().textContent = item.name;
                
                // Cell for the image search button
                const imageSearchCell = newRow.insertCell();
                const imageSearchButton = document.createElement('button');
                imageSearchButton.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-800', 'py-1', 'px-2', 'rounded-full', 'text-xs', 'transition-colors', 'duration-200');
                imageSearchButton.title = `Buscar imagen de ${item.itemId}`;
                imageSearchButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image">
                        <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                        <circle cx="9" cy="9" r="2"/>
                        <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                    </svg>
                `;
                imageSearchButton.addEventListener('click', () => searchImageInGoogle(item.itemId, item.name));
                imageSearchCell.appendChild(imageSearchButton);
                imageSearchCell.classList.add('text-center'); // Center the icon in its cell


                newRow.insertCell().textContent = item.category;
                newRow.insertCell().textContent = item.quantity;
                newRow.insertCell().textContent = item.unit; // New: Display unit
                newRow.insertCell().textContent = item.location;
                newRow.insertCell().textContent = item.minStock;

                const actionsCell = newRow.insertCell();
                actionsCell.classList.add('flex', 'flex-col', 'space-y-1', 'justify-center', 'items-center'); // Center buttons vertically

                const withdrawButton = document.createElement('button');
                withdrawButton.textContent = 'Retirar Cantidad';
                withdrawButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'font-bold', 'py-1', 'px-3', 'rounded-full', 'text-xs', 'transition-colors', 'duration-200');
                withdrawButton.addEventListener('click', function() { 
                    openWithdrawalModal(item.id, item.itemId, item.name, item.quantity); 
                });
                actionsCell.appendChild(withdrawButton);

                // Nuevo botón de editar
                const editButton = document.createElement('button');
                editButton.textContent = 'Editar';
                editButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'font-bold', 'py-1', 'px-3', 'rounded-full', 'text-xs', 'transition-colors', 'duration-200', 'mt-1');
                editButton.addEventListener('click', function() {
                    openEditItemModal(item.id, item.itemId, item.name, item.category, item.quantity, item.unit, item.location, item.minStock);
                });
                actionsCell.appendChild(editButton);

                // NEW: Button to view item-specific history
                const viewHistoryButton = document.createElement('button');
                viewHistoryButton.textContent = 'Historial';
                viewHistoryButton.classList.add('bg-indigo-500', 'hover:bg-indigo-600', 'text-white', 'font-bold', 'py-1', 'px-3', 'rounded-full', 'text-xs', 'transition-colors', 'duration-200', 'mt-1');
                viewHistoryButton.addEventListener('click', function() {
                    openItemHistoryModal(item.itemId, item.name);
                });
                actionsCell.appendChild(viewHistoryButton);


                // Nuevo botón de eliminar
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Eliminar';
                deleteButton.classList.add('bg-gray-600', 'hover:bg-gray-700', 'text-white', 'font-bold', 'py-1', 'px-3', 'rounded-full', 'text-xs', 'transition-colors', 'duration-200', 'mt-1');
                deleteButton.addEventListener('click', function() { 
                    deleteItem(item.id, item.itemId, item.name); 
                });
                actionsCell.appendChild(deleteButton);
            });

            document.getElementById('total-items').textContent = totalItemsCount;
            document.getElementById('critical-items').textContent = criticalItemsCount;
            document.getElementById('total-stock').textContent = totalStockQuantity; // New: Update total stock quantity
            updateLastUpdateTime();
            lucide.createIcons(); // Re-render Lucide icons after updating table

            // Improvement 5: Real-time notification for critical stock
            const criticalItemsCard = document.getElementById('critical-items-card');
            if (criticalItemsCount > 0) {
                criticalItemsCard.classList.remove('bg-white', 'border-gray-200', 'hover:bg-red-50');
                criticalItemsCard.classList.add('bg-red-100', 'border-red-400', 'shadow-lg', 'pulse-red');
                showMessage(`¡ATENCIÓN! Hay ${criticalItemsCount} artículos en stock crítico.`, true);
            } else {
                criticalItemsCard.classList.remove('bg-red-100', 'border-red-400', 'shadow-lg', 'pulse-red');
                criticalItemsCard.classList.add('bg-white', 'border-gray-200', 'hover:bg-red-50');
            }

            // Call render charts and reorder suggestions after inventory is rendered
            renderCharts(items);
            renderReorderSuggestions(items); // This function will also update `reorderItemsToPrint`
        }

        // Variables para el modal de retiro individual
        let selectedDbKeyForWithdrawal = null; 
        let selectedItemIdForWithdrawal = null;
        let selectedItemNameForWithdrawal = null;
        let selectedItemCurrentQuantity = 0;

        // Función para abrir el modal de retiro individual
        function openWithdrawalModal(dbKey, itemId, itemName, currentQuantity) {
            selectedDbKeyForWithdrawal = dbKey;
            selectedItemIdForWithdrawal = itemId;
            selectedItemNameForWithdrawal = itemName;
            selectedItemCurrentQuantity = currentQuantity;

            document.getElementById('modal-item-id').textContent = itemId;
            document.getElementById('modal-item-name').textContent = itemName;
            document.getElementById('modal-item-current-quantity').textContent = currentQuantity; 
            document.getElementById('withdrawal-quantity').value = ''; 
            document.getElementById('withdrawal-responsible').value = currentUserIdentifier; // Set default to current user

            document.getElementById('withdrawal-modal').classList.add('flex');
        }

        // Función para cerrar el modal de retiro individual
        function cancelWithdrawal() {
            document.getElementById('withdrawal-modal').classList.remove('flex');
            selectedDbKeyForWithdrawal = null;
            selectedItemIdForWithdrawal = null;
            selectedItemNameForWithdrawal = null;
            selectedItemCurrentQuantity = 0;
        }

        // Función para confirmar y procesar el retiro individual
        async function confirmWithdrawal() {
            const withdrawalQuantity = parseInt(document.getElementById('withdrawal-quantity').value);
            const responsible = document.getElementById('withdrawal-responsible').value.trim() || currentUserIdentifier; // Use input value or default

            if (isNaN(withdrawalQuantity) || withdrawalQuantity <= 0) {
                showMessage('Por favor, ingrese una cantidad válida a retirar (mayor que 0).', true);
                return;
            }

            if (withdrawalQuantity > selectedItemCurrentQuantity) {
                showMessage(`No hay suficientes "${selectedItemNameForWithdrawal}" en stock. Cantidad disponible: ${selectedItemCurrentQuantity}.`, true);
                return;
            }

            if (!responsible) {
                showMessage('Por favor, ingrese el responsable del retiro.', true);
                return;
            }

            const newQuantity = selectedItemCurrentQuantity - withdrawalQuantity;

            try {
                // Point to public inventory
                const itemDbRef = ref(db, `artifacts/${appId}/public/data/inventory/${selectedDbKeyForWithdrawal}`);
                
                if (newQuantity <= 0) {
                    await remove(itemDbRef); 
                    showMessage(`Artículo "${selectedItemNameForWithdrawal}" completamente retirado y eliminado del inventario.`, false);
                } else {
                    await update(itemDbRef, { quantity: newQuantity }); 
                    showMessage(`Se retiraron ${withdrawalQuantity} unidades de "${selectedItemNameForWithdrawal}". Cantidad restante: ${newQuantity}.`, false);
                }
                
                await addMovementToHistory(selectedItemIdForWithdrawal, selectedItemNameForWithdrawal, 'Retiro', withdrawalQuantity, 'Salida de Inventario (Individual)', responsible);
                console.log(`Retiro procesado para ${selectedItemNameForWithdrawal}.`);
                cancelWithdrawal();
            } catch (e) {
                console.error("Error al procesar el retiro en Realtime Database: ", e);
                showMessage("Error al procesar el retiro. Intente de nuevo.", true);
            }
        }

        // Función para eliminar un artículo
        async function deleteItem(dbKey, itemId, itemName) {
            if (!isAuthReady) {
                showMessage("La base de datos no está lista. Intente de nuevo en unos segundos.", true);
                return;
            }

            const confirmed = await showConfirm(
                'Confirmar Eliminación',
                `¿Está seguro de que desea eliminar el artículo "${itemName}" (Número de Parte: ${itemId}) del inventario? Esta acción es irreversible.`
            );
            
            if (!confirmed) {
                return; 
            }

            try {
                // Point to public inventory
                const itemDbRef = ref(db, `artifacts/${appId}/public/data/inventory/${dbKey}`);
                await remove(itemDbRef); 

                await addMovementToHistory(itemId, itemName, 'Eliminación', 0, 'Eliminado del Inventario', currentUserIdentifier); 
                console.log(`Artículo "${itemName}" eliminado.`);
                showMessage(`Artículo "${itemName}" eliminado con éxito.`, false);
            } catch (e) {
                console.error("Error al eliminar el artículo de Realtime Database: ", e);
                showMessage("Error al eliminar el artículo. Intente de nuevo.", true);
            }
        }

        // Function to render history items to the table
        function renderHistory(movements) {
            const historyTableBody = document.getElementById('movement-history-list');
            historyTableBody.innerHTML = ''; // Clear current table
            allMovementHistory = movements; // Store all movements for item-specific history

            // Sort movements by timestamp in descending order (most recent first)
            // Timestamps are ISO strings, so direct comparison works
            movements.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            movements.forEach(move => {
                const newRow = historyTableBody.insertRow();
                newRow.classList.add('hover:bg-gray-50');

                newRow.insertCell().textContent = new Date(move.timestamp).toLocaleString('es-ES', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                }).replace(/\//g, '-');
                newRow.insertCell().textContent = move.itemId;
                newRow.insertCell().textContent = move.itemName;
                newRow.insertCell().textContent = move.movementType;
                newRow.insertCell().textContent = move.quantity;
                newRow.insertCell().textContent = move.sourceDestination;
                newRow.insertCell().textContent = move.responsible;
            });
        }

        // Function to render invoice history items to the table
        function renderInvoices(invoices) {
            const invoiceHistoryTableBody = document.getElementById('invoice-history-list');
            invoiceHistoryTableBody.innerHTML = ''; // Clear current table

            // Sort invoices by timestamp in descending order (most recent first)
            invoices.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            invoices.forEach(invoice => {
                const newRow = invoiceHistoryTableBody.insertRow();
                newRow.classList.add('hover:bg-gray-50');

                newRow.insertCell().textContent = invoice.invoiceId.substring(0, 8); // Display first 8 chars of Firebase key as Invoice ID
                newRow.insertCell().textContent = new Date(invoice.timestamp).toLocaleString('es-ES', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', hour12: false
                }).replace(/\//g, '-');
                newRow.insertCell().textContent = invoice.responsible;
                
                const itemsSummaryCell = newRow.insertCell();
                if (invoice.items && Array.isArray(invoice.items)) {
                    itemsSummaryCell.textContent = invoice.items.map(item => `${item.name} (x${item.quantityToWithdraw})`).join(', ');
                } else {
                    itemsSummaryCell.textContent = 'N/A';
                }

                const actionsCell = newRow.insertCell();
                const printButton = document.createElement('button');
                printButton.textContent = 'Imprimir';
                printButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'font-bold', 'py-1', 'px-3', 'rounded-full', 'text-xs', 'transition-colors', 'duration-200');
                printButton.addEventListener('click', () => printExistingInvoice(invoice)); // Function to print an existing invoice
                actionsCell.appendChild(printButton);
            });
        }

        // --- Historial: Borrar Historial Completo ---
        async function clearHistory() {
            if (!isAuthReady) {
                showMessage("La base de datos no está lista. Intente de nuevo en unos segundos.", true);
                return;
            }

            const confirmed = await showConfirm(
                'Borrar Historial Completo',
                `¿Está seguro de que desea eliminar TODO el historial de movimientos? Esta acción es irreversible.`
            );

            if (!confirmed) {
                return;
            }

            try {
                // Point to public history
                await remove(historyRef); // Elimina todo el nodo de historial
                showMessage('Historial de movimientos borrado con éxito.', false);
                console.log("Historial de movimientos borrado.");
            } catch (e) {
                console.error("Error al borrar el historial de Realtime Database: ", e);
                showMessage("Error al borrar el historial. Intente de nuevo.", true);
            }
        }

        // --- Nuevo: Funcionalidad de Factura de Entrega (Múltiples Componentes) ---

        let deliveryItems = [];

        function openDeliveryInvoiceModal() {
            deliveryItems = []; 
            renderDeliveryItems(); 
            document.getElementById('delivery-responsible').value = currentUserIdentifier; // Set default to current user
            document.getElementById('delivery-search-input').value = ''; 
            document.getElementById('delivery-search-results').classList.add('hidden'); // Hide search results on open
            document.getElementById('print-delivery-invoice-btn').classList.add('hidden'); // Hide print button initially
            document.getElementById('delivery-invoice-modal').classList.add('flex');
        }

        function cancelDeliveryInvoice() {
            document.getElementById('delivery-invoice-modal').classList.remove('flex');
            deliveryItems = []; 
            document.getElementById('print-delivery-invoice-btn').classList.add('hidden'); // Ensure hidden on cancel
        }

        // Nuevo: Función para filtrar y mostrar resultados de búsqueda en vivo en el modal de entrega
        function filterDeliverySearch() {
            const searchInput = document.getElementById('delivery-search-input').value.trim().toUpperCase();
            const searchResultsDiv = document.getElementById('delivery-search-results');
            searchResultsDiv.innerHTML = ''; // Clear previous results

            if (searchInput.length < 2) { // Only search if at least 2 characters are typed
                searchResultsDiv.classList.add('hidden');
                return;
            }

            const filteredItems = currentInventoryItems.filter(item => 
                item.itemId.toUpperCase().includes(searchInput) || 
                item.name.toUpperCase().includes(searchInput) ||
                item.category.toUpperCase().includes(searchInput)
            );

            if (filteredItems.length === 0) {
                searchResultsDiv.classList.add('hidden');
                return;
            }

            searchResultsDiv.classList.remove('hidden');
            filteredItems.forEach(item => {
                const resultItemDiv = document.createElement('div');
                resultItemDiv.classList.add('search-result-item');
                resultItemDiv.textContent = `${item.name} (Número de Parte: ${item.itemId}, Stock: ${item.quantity} ${item.unit || ''})`; // Include unit in search results
                resultItemDiv.addEventListener('click', () => addItemToDeliveryModal(item));
                searchResultsDiv.appendChild(resultItemDiv);
            });
        }

        // Nuevo: Función para añadir un artículo de los resultados de búsqueda a la factura de entrega
        function addItemToDeliveryModal(item) {
            const existingItemIndex = deliveryItems.findIndex(dItem => dItem.itemId === item.itemId);
            if (existingItemIndex !== -1) {
                showMessage(`"${item.name}" ya está en la factura.`, true);
            } else {
                deliveryItems.push({ 
                    dbKey: item.id, // Realtime Database key
                    itemId: item.itemId,
                    name: item.name,
                    currentStock: item.quantity,
                    unit: item.unit || '', // Add unit to delivery item
                    quantityToWithdraw: 1, // Default quantity to 1
                    finalStock: item.currentStock - 1 // Initial calculation for final stock
                });
                renderDeliveryItems();
                document.getElementById('delivery-search-input').value = ''; // Clear search input
                document.getElementById('delivery-search-results').classList.add('hidden'); // Hide results
                showMessage(`"${item.name}" añadido a la factura.`, false);
            }
        }


        function renderDeliveryItems() {
            const deliveryListBody = document.getElementById('delivery-items-list');
            deliveryListBody.innerHTML = ''; 

            deliveryItems.forEach((item, index) => {
                const row = deliveryListBody.insertRow();
                row.insertCell().textContent = item.itemId; 
                row.insertCell().textContent = item.name;
                
                const quantityCell = row.insertCell();
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.min = '1';
                quantityInput.value = item.quantityToWithdraw;
                quantityInput.classList.add('w-20', 'px-2', 'py-1', 'border', 'rounded-md', 'text-xs'); /* Smaller input for mobile */
                quantityInput.onchange = (e) => {
                    const newQty = parseInt(e.target.value);
                    if (isNaN(newQty) || newQty <= 0) {
                        showMessage('Cantidad inválida. Debe ser un número mayor que 0.', true);
                        e.target.value = item.quantityToWithdraw;
                        return;
                    }
                    if (newQty > item.currentStock) {
                        showMessage(`No puedes retirar ${newQty} de ${item.name}. Stock disponible: ${item.currentStock}.`, true);
                        e.target.value = item.quantityToWithdraw;
                        return;
                    }
                    item.quantityToWithdraw = newQty;
                    item.finalStock = item.currentStock - newQty; // Update final stock on change
                };
                quantityCell.appendChild(quantityInput);

                row.insertCell().textContent = `${item.currentStock} ${item.unit || ''}`; // Display current stock with unit

                const actionCell = row.insertCell();
                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remover';
                removeButton.classList.add('bg-gray-400', 'hover:bg-gray-500', 'text-white', 'font-bold', 'py-1', 'px-2', 'rounded-full', 'text-xs');
                removeButton.onclick = () => {
                    deliveryItems.splice(index, 1);
                    renderDeliveryItems();
                    showMessage(`"${item.name}" eliminado de la factura.`, false);
                };
                actionCell.appendChild(removeButton);
            });
        }

        async function confirmDeliveryInvoice() {
            const responsible = document.getElementById('delivery-responsible').value.trim() || currentUserIdentifier; // Use input value or default
            if (!responsible) {
                showMessage('Por favor, ingrese el responsable de la entrega.', true);
                return;
            }

            if (deliveryItems.length === 0) {
                showMessage('No hay artículos en la factura de entrega.', true);
                return;
            }

            let deliverySummary = [];
            let allValid = true;

            deliveryItems.forEach(item => {
                if (item.quantityToWithdraw <= 0 || isNaN(item.quantityToWithdraw)) {
                    showMessage(`Error: Cantidad inválida para "${item.name}".`, true);
                    allValid = false;
                }
                if (item.quantityToWithdraw > item.currentStock) {
                    showMessage(`Error: No hay suficiente stock para "${item.name}". Solo quedan ${item.currentStock}.`, true);
                    allValid = false;
                }
            });

            if (!allValid) {
                return;
            }

            try {
                const updates = {};
                let finalInvoiceItems = []; // To store items for invoice history

                for (const item of deliveryItems) {
                    const newQuantity = item.currentStock - item.quantityToWithdraw;
                    // Point to public inventory
                    const itemPath = `artifacts/${appId}/public/data/inventory/${item.dbKey}`;
                    
                    if (newQuantity <= 0) {
                        updates[itemPath] = null; 
                    } else {
                        updates[itemPath + '/quantity'] = newQuantity; 
                    }
                    // Update final stock in deliveryItems array for printing and invoice history
                    item.finalStock = newQuantity; 
                    finalInvoiceItems.push({ // Prepare item for invoice history
                        itemId: item.itemId,
                        name: item.name,
                        quantityToWithdraw: item.quantityToWithdraw,
                        currentStock: item.currentStock,
                        unit: item.unit, // Include unit in invoice items
                        finalStock: item.finalStock 
                    });
                    deliverySummary.push(`${item.name} (x${item.quantityToWithdraw} ${item.unit || ''})`);
                }

                // Apply updates to the public database root
                await update(ref(db, '/'), updates);

                // Add entry to movement history (public)
                await addMovementToHistory(
                    'MÚLTIPLE',
                    'Entrega de componentes',
                    'Entrega',
                    deliveryItems.reduce((sum, item) => sum + item.quantityToWithdraw, 0),
                    'Artículos: ' + deliverySummary.join(', '),
                    responsible
                );

                // Add entry to invoice history (public)
                const newInvoiceRef = push(invoiceHistoryRef);
                await set(newInvoiceRef, {
                    timestamp: new Date().toISOString(),
                    responsible: responsible,
                    items: finalInvoiceItems // Store the processed items
                });

                console.log('Factura de entrega procesada con éxito. Stock actualizado.');
                showMessage('Factura de entrega procesada con éxito. Stock actualizado.', false);
                document.getElementById('print-delivery-invoice-btn').classList.remove('hidden'); // Show print button
                // cancelDeliveryInvoice(); // Don't close immediately, let user print first
            } catch (e) {
                console.error("Error al procesar la factura de entrega en Realtime Database: ", e);
                showMessage("Error al procesar la factura de entrega. Intente de nuevo.", true);
            }
        }

        // Function to print a newly generated invoice
        function printDeliveryInvoice() {
            const responsible = document.getElementById('delivery-responsible').value.trim();
            const now = new Date().toLocaleString('es-ES', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: false
            }).replace(/\//g, '-');
            
            const printUserId = userId; // Use the global userId directly

            let invoiceContent = `
                <html lang="es">
                <head>
                    <title>Factura de Entrega</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 20px; color: #333; }
                        .invoice-container { 
                            width: 80%; 
                            margin: 0 auto; 
                            border: 1px solid #ccc; 
                            padding: 20px; 
                            box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        }
                        .invoice-header { 
                            display: flex; 
                            justify-content: space-between; 
                            align-items: center; 
                            margin-bottom: 20px; 
                            border-bottom: 2px solid #1e40af; 
                            padding-bottom: 10px;
                            position: relative; /* Ensure relative positioning for absolute children */
                        }
                        .invoice-header h1 { 
                            text-align: left; 
                            color: #1e40af; 
                            margin: 0; 
                            font-size: 2em; 
                            flex-grow: 1;
                        }
                        .invoice-header .print-logo-left {
                            max-width: 100px; 
                            height: auto; 
                            border-radius: 8px;
                            position: absolute;
                            left: 0;
                            top: 50%;
                            transform: translateY(-50%);
                        }
                        .invoice-header .print-logo-right { 
                            max-width: 100px; 
                            height: auto; 
                            border-radius: 8px;
                            position: absolute;
                            right: 0;
                            top: 50%;
                            transform: translateY(-50%);
                        }
                        .header-info-block { 
                            display: flex; 
                            justify-content: space-between; 
                            margin-bottom: 20px; 
                            font-size: 0.9em; 
                            line-height: 1.5;
                            flex-wrap: wrap; /* Allow wrapping on smaller screens */
                        }
                        .header-info-block div { 
                            width: 48%; /* Adjust for two columns */
                            margin-bottom: 10px; /* Space between rows on wrap */
                        }
                        .header-info-block div:last-child {
                            text-align: right; /* Align date/ID to the right */
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-top: 20px; 
                            font-size: 0.9em;
                        }
                        th, td { 
                            border: 1px solid #ddd; 
                            padding: 8px; 
                            text-align: left; 
                        }
                        th { 
                            background-color: #f2f2f2; 
                            color: #555;
                        }
                        .signatures-container { 
                            margin-top: 50px; 
                            text-align: center; 
                            display: grid; /* Use grid for better control */
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responsive grid */
                            gap: 20px; /* Spacing between signature blocks */
                        }
                        .signature-block { 
                            /* Flex properties are less needed with grid, but can fine-tune */
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                        }
                        .signature-line { 
                            border-bottom: 1px solid #000; 
                            height: 40px; /* Height for signature space */
                            width: 100%; /* Ensure line stretches within its block */
                            max-width: 250px; /* Max width for line */
                            margin-bottom: 5px; 
                        }
                        .signature-label { 
                            font-size: 0.9em; 
                            margin-top: 5px; 
                            color: #555;
                        }
                        @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .invoice-container { width: 100%; border: none; padding: 0; box-shadow: none; }
                            .invoice-header, .signatures-container { page-break-inside: avoid; }
                            table { page-break-inside: auto; }
                            tr { page-break-inside: avoid; page-break-after: auto; }
                            .invoice-header h1 {
                                /* Adjust margin for print layout if logos are absolute */
                                margin: 0 120px; /* Example: space for 100px logo + 20px margin */
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="invoice-container">
                        <div class="invoice-header">
                            <img src="https://placehold.co/100x100/blue/white?text=LOGO_IZQUIERDA" onerror="this.onerror=null; this.src='https://placehold.co/100x100/blue/white?text=LOGO_ERROR_LEFT'" alt="Escudo de Honduras" class="print-logo-left">
                            <h1>Factura de Entrega</h1>
                            <img src="https://placehold.co/100x100/blue/white?text=LOGO_DERECHA" onerror="this.onerror=null; this.src='https://placehold.co/100x100/blue/white?text=LOGO_ERROR_RIGHT'" alt="Logo de la Fuerza Aérea Hondureña" class="print-logo-right">
                        </div>
                        <div class="header-info-block">
                            <div>
                                <p><strong>Responsable de la Entrega:</strong> ${responsible}</p>
                            </div>
                            <div>
                                <p><strong>Fecha:</strong> ${now}</p>
                                <p><strong>Número de Parte de Usuario:</strong> ${printUserId}</p>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Número de Parte Artículo</th>
                                    <th>Nombre</th>
                                    <th>Cantidad Retirada</th>
                                    <th>Stock Inicial</th>
                                    <th>Stock Final</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${deliveryItems.map(item => `
                                    <tr>
                                        <td>${item.itemId}</td>
                                        <td>${item.name}</td>
                                        <td>${item.quantityToWithdraw} ${item.unit || ''}</td>
                                        <td>${item.currentStock} ${item.unit || ''}</td>
                                        <td>${item.finalStock} ${item.unit || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="signatures-container">
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <p class="signature-label">Jefe de Taller</p>
                            </div>
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <p class="signature-label">Aprobado por A-4</p>
                            </div>
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <p class="signature-label">Entregado por</p>
                            </div>
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <p class="signature-label">Recibido por</p>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.open();
                printWindow.document.write(invoiceContent);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                // printWindow.close(); // Optional: close after printing, but user might want to review
            } else {
                showMessage("No se pudo abrir la ventana de impresión. Asegúrese de que los bloqueadores de pop-ups estén desactivados.", true);
            }
        }

        // New function to print an existing invoice from history
        function printExistingInvoice(invoice) {
             const now = new Date(invoice.timestamp).toLocaleString('es-ES', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: false
            }).replace(/\//g, '-');
            
            const printUserId = userId; // Use the global userId directly, as it's the current user viewing

            let invoiceContent = `
                <html lang="es">
                <head>
                    <title>Factura de Entrega #${invoice.invoiceId.substring(0,8)}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 20px; color: #333; }
                        .invoice-container { 
                            width: 80%; 
                            margin: 0 auto; 
                            border: 1px solid #ccc; 
                            padding: 20px; 
                            box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        }
                        .invoice-header { 
                            display: flex; 
                            justify-content: space-between; 
                            align-items: center; 
                            margin-bottom: 20px; 
                            border-bottom: 2px solid #1e40af; 
                            padding-bottom: 10px;
                            position: relative; /* Ensure relative positioning for absolute children */
                        }
                        .invoice-header h1 { 
                            text-align: left; 
                            color: #1e40af; 
                            margin: 0; 
                            font-size: 2em; 
                            flex-grow: 1;
                        }
                        .invoice-header .print-logo-left {
                            max-width: 100px; 
                            height: auto; 
                            border-radius: 8px;
                            position: absolute;
                            left: 0;
                            top: 50%;
                            transform: translateY(-50%);
                        }
                        .invoice-header .print-logo-right { 
                            max-width: 100px; 
                            height: auto; 
                            border-radius: 8px;
                            position: absolute;
                            right: 0;
                            top: 50%;
                            transform: translateY(-50%);
                        }
                        .header-info-block { 
                            display: flex; 
                            justify-content: space-between; 
                            margin-bottom: 20px; 
                            font-size: 0.9em; 
                            line-height: 1.5;
                            flex-wrap: wrap; /* Allow wrapping on smaller screens */
                        }
                        .header-info-block div { 
                            width: 48%; /* Adjust for two columns */
                            margin-bottom: 10px; /* Space between rows on wrap */
                        }
                        .header-info-block div:last-child {
                            text-align: right; /* Align date/ID to the right */
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-top: 20px; 
                            font-size: 0.9em;
                        }
                        th, td { 
                            border: 1px solid #ddd; 
                            padding: 8px; 
                            text-align: left; 
                        }
                        th { 
                            background-color: #f2f2f2; 
                            color: #555;
                        }
                        .signatures-container { 
                            margin-top: 50px; 
                            text-align: center; 
                            display: grid; /* Use grid for better control */
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responsive grid */
                            gap: 20px; /* Spacing between signature blocks */
                        }
                        .signature-block { 
                            /* Flex properties are less needed with grid, but can fine-tune */
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                        }
                        .signature-line { 
                            border-bottom: 1px solid #000; 
                            height: 40px; /* Height for signature space */
                            width: 100%; /* Ensure line stretches within its block */
                            max-width: 250px; /* Max width for line */
                            margin-bottom: 5px; 
                        }
                        .signature-label { 
                            font-size: 0.9em; 
                            margin-top: 5px; 
                            color: #555;
                        }
                        @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .invoice-container { width: 100%; border: none; padding: 0; box-shadow: none; }
                            .invoice-header, .signatures-container { page-break-inside: avoid; }
                            table { page-break-inside: auto; }
                            tr { page-break-inside: avoid; page-break-after: auto; }
                            .invoice-header h1 {
                                /* Adjust margin for print layout if logos are absolute */
                                margin: 0 120px; /* Example: space for 100px logo + 20px margin */
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="invoice-container">
                        <div class="invoice-header">
                            <img src="https://placehold.co/100x100/blue/white?text=LOGO_IZQUIERDA" onerror="this.onerror=null; this.src='https://placehold.co/100x100/blue/white?text=LOGO_ERROR_LEFT'" alt="Escudo de Honduras" class="print-logo-left">
                            <h1>Factura de Entrega #${invoice.invoiceId.substring(0,8)}</h1>
                            <img src="https://placehold.co/100x100/blue/white?text=LOGO_DERECHA" onerror="this.onerror=null; this.src='https://placehold.co/100x100/blue/white?text=LOGO_ERROR_RIGHT'" alt="Logo de la Fuerza Aérea Hondureña" class="print-logo-right">
                        </div>
                        <div class="header-info-block">
                            <div>
                                <p><strong>Responsable de la Entrega:</strong> ${invoice.responsible}</p>
                            </div>
                            <div>
                                <p><strong>Número de Parte de Usuario:</strong> ${printUserId}</p>
                                <p><strong>Fecha:</strong> ${now}</p>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Número de Parte Artículo</th>
                                    <th>Nombre</th>
                                    <th>Cantidad Retirada</th>
                                    <th>Stock Inicial</th>
                                    <th>Stock Final</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.items.map(item => `
                                    <tr>
                                        <td>${item.itemId}</td>
                                        <td>${item.name}</td>
                                        <td>${item.quantityToWithdraw} ${item.unit || ''}</td>
                                        <td>${item.currentStock} ${item.unit || ''}</td>
                                        <td>${item.finalStock} ${item.unit || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="signatures-container">
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <p class="signature-label">Jefe de Taller</p>
                            </div>
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <p class="signature-label">Aprobado por A-4</p>
                            </div>
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <p class="signature-label">Entregado por</p>
                            </div>
                            <div class="signature-block">
                                <div class="signature-line"></div>
                                <p class="signature-label">Recibido por</p>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.open();
                printWindow.document.write(invoiceContent);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
            } else {
                showMessage("No se pudo abrir la ventana de impresión. Asegúrese de que los bloqueadores de pop-ups estén desactivados.", true);
            }
        }


        // --- Historial de Facturas: Borrar Historial Completo ---
        async function clearInvoiceHistory() {
            if (!isAuthReady) {
                showMessage("La base de datos no está lista. Intente de nuevo en unos segundos.", true);
                return;
            }

            const confirmed = await showConfirm(
                'Borrar Historial de Facturas Completo',
                `¿Está seguro de que desea eliminar TODO el historial de facturas? Esta acción es irreversible.`
            );

            if (!confirmed) {
                return;
            }

            try {
                // Point to public invoice history
                await remove(invoiceHistoryRef); // Elimina todo el nodo de historial de facturas
                showMessage('Historial de facturas borrado con éxito.', false);
                console.log("Historial de facturas borrado.");
            } catch (e) {
                console.error("Error al borrar el historial de facturas de Realtime Database: ", e);
                showMessage("Error al borrar el historial. Intente de nuevo.", true);
            }
        }


        // --- Funcionalidad de Búsqueda de Inventario Principal ---
        function searchInventory() {
            const input = document.getElementById('search-input');
            const filter = input.value.toUpperCase(); 
            const tableBody = document.getElementById('inventory-list');
            const tr = tableBody.getElementsByTagName('tr');

            for (let i = 0; i < tr.length; i++) {
                let found = false;
                // Updated indices: 0: Numbero de Parte, 1: Nombre, 2: Imagen, 3: Categoria, 4: Cantidad, 5: Unidad, 6: Ubicacion, 7: Stock Minimo, 8: Acciones
                const itemIdCell = tr[i].cells[0]; // Numero de Parte
                const itemNameCell = tr[i].cells[1]; // Nombre del Articulo
                const itemCategoryCell = tr[i].cells[3]; // Categoria
                const itemUnitCell = tr[i].cells[5]; // Unidad
                const itemLocationCell = tr[i].cells[6]; // Ubicacion

                if (itemIdCell && itemIdCell.textContent.toUpperCase().indexOf(filter) > -1) {
                    found = true;
                } else if (itemNameCell && itemNameCell.textContent.toUpperCase().indexOf(filter) > -1) {
                    found = true;
                } else if (itemCategoryCell && itemCategoryCell.textContent.toUpperCase().indexOf(filter) > -1) {
                    found = true;
                } else if (itemUnitCell && itemUnitCell.textContent.toUpperCase().indexOf(filter) > -1) {
                    found = true;
                } else if (itemLocationCell && itemLocationCell.textContent.toUpperCase().indexOf(filter) > -1) {
                    found = true;
                }
                
                if (found) {
                    tr[i].style.display = ''; 
                } else {
                    tr[i].style.display = 'none'; 
                }
            }
        }

        // Función para limpiar la búsqueda y mostrar todas las filas
        function clearSearch() {
            document.getElementById('search-input').value = ''; 
            const tableBody = document.getElementById('inventory-list');
            const tr = tableBody.getElementsByTagName('tr');
            for (let i = 0; i < tr.length; i++) {
                tr[i].style.display = ''; // Mostrar todas las filas
            }
            showMessage("Mostrando todos los artículos.", false);
        }

        // Function to filter and display only critical items
        function filterCriticalItems() {
            document.getElementById('search-input').value = ''; // Clear search input when filtering critical items

            const tableBody = document.getElementById('inventory-list');
            const tr = tableBody.getElementsByTagName('tr');

            let criticalItemsFound = false;

            for (let i = 0; i < tr.length; i++) {
                // Quantity is at index 4, Min Stock is at index 7 (after adding image and unit columns)
                const itemQuantity = parseInt(tr[i].cells[4].textContent); 
                const minStock = parseInt(tr[i].cells[7].textContent); 

                if (itemQuantity <= minStock) {
                    tr[i].style.display = ''; // Show critical item
                    criticalItemsFound = true;
                } else {
                    tr[i].style.display = 'none'; // Hide non-critical item
                }
            }

            if (!criticalItemsFound) {
                showMessage("No hay artículos críticos en este momento.", false);
            } else {
                showMessage("Mostrando solo artículos críticos.", false);
            }
            // Scroll to the inventory section to show the filtered results
            document.getElementById('inventario-actual').scrollIntoView({ behavior: 'smooth' });
        }

        // Function to print the current inventory
        function printInventory() {
            const now = new Date().toLocaleString('es-ES', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: false
            }).replace(/\//g, '-');
            
            const printUserId = userId; 

            // Get the current visible items in the inventory table
            const tableBody = document.getElementById('inventory-list');
            const rows = tableBody.getElementsByTagName('tr');
            let inventoryItemsToPrint = [];

            for (let i = 0; i < rows.length; i++) {
                // Only include visible rows (those not hidden by filters)
                if (rows[i].style.display !== 'none') {
                    const cells = rows[i].getElementsByTagName('td');
                    // Adjust cell indices for the new 'Imagen' column
                    inventoryItemsToPrint.push({
                        itemId: cells[0].textContent,
                        name: cells[1].textContent,
                        category: cells[3].textContent, // Category is now at index 3
                        quantity: cells[4].textContent, // Quantity is now at index 4
                        unit: cells[5].textContent, // Unit is now at index 5
                        location: cells[6].textContent, // Location is now at index 6
                        minStock: cells[7].textContent // Min Stock is now at index 7
                    });
                }
            }

            let inventoryContent = `
                <html lang="es">
                <head>
                    <title>Inventario Actual</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 20px; color: #333; }
                        .inventory-container { 
                            width: 80%; 
                            margin: 0 auto; 
                            border: 1px solid #ccc; 
                            padding: 20px; 
                            box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        }
                        .inventory-header { 
                            display: flex; 
                            justify-content: space-between; 
                            align-items: center; 
                            margin-bottom: 20px; 
                            border-bottom: 2px solid #1e40af; 
                            padding-bottom: 10px;
                            position: relative; /* Ensure relative positioning for absolute children */
                        }
                        .inventory-header h1 { 
                            text-align: left; 
                            color: #1e40af; 
                            margin: 0; 
                            font-size: 2em; 
                            flex-grow: 1;
                        }
                        .inventory-header .print-logo-left {
                            max-width: 100px; 
                            height: auto; 
                            border-radius: 8px;
                            position: absolute;
                            left: 0;
                            top: 50%;
                            transform: translateY(-50%);
                        }
                        .inventory-header .print-logo-right { 
                            max-width: 100px; 
                            height: auto; 
                            border-radius: 8px;
                            position: absolute;
                            right: 0;
                            top: 50%;
                            transform: translateY(-50%);
                        }
                        .header-info-block { 
                            display: flex; 
                            justify-content: space-between; 
                            margin-bottom: 20px; 
                            font-size: 0.9em; 
                            line-height: 1.5;
                            flex-wrap: wrap;
                        }
                        .header-info-block div { 
                            width: 48%; 
                            margin-bottom: 10px;
                        }
                        .header-info-block div:last-child {
                            text-align: right;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-top: 20px; 
                            font-size: 0.9em;
                        }
                        th, td { 
                            border: 1px solid #ddd; 
                            padding: 8px; 
                            text-align: left; 
                        }
                        th { 
                            background-color: #f2f2f2; 
                            color: #555;
                        }
                        .created-by-text {
                            font-family: 'Bebas Neue', sans-serif !important; /* Ensure font applies for print */
                            font-size: 0.8em !important;
                            color: #555 !important;
                            margin-top: 5px !important;
                            letter-spacing: 1px !important;
                        }
                        @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .inventory-container { width: 100%; border: none; padding: 0; box-shadow: none; }
                            .inventory-header { page-break-inside: avoid; }
                            table { page-break-inside: auto; }
                            tr { page-break-inside: avoid; page-break-after: auto; }
                            .inventory-header h1 {
                                /* Adjust margin for print layout if logos are absolute */
                                margin: 0 120px; /* Example: space for 100px logo + 20px margin */
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="inventory-container">
                        <div class="inventory-header">
                            <img src="https://placehold.co/100x100/blue/white?text=LOGO_IZQUIERDA" onerror="this.onerror=null; this.src='https://placehold.co/100x100/blue/white?text=LOGO_ERROR_LEFT'" alt="Escudo de Honduras" class="print-logo-left">
                            <h1>Inventario Actual</h1>
                            <img src="https://placehold.co/100x100/blue/white?text=LOGO_DERECHA" onerror="this.onerror=null; this.src='https://placehold.co/100x100/blue/white?text=LOGO_ERROR_RIGHT'" alt="Logo de la Fuerza Aérea Hondureña" class="print-logo-right">
                        </div>
                        <div class="header-info-block">
                            <div>
                                <p><strong>Fecha de Impresión:</strong> ${now}</p>
                            </div>
                            <div>
                                <p><strong>Número de Parte de Usuario:</strong> ${printUserId}</p>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Número de Parte Artículo</th>
                                    <th>Nombre del Artículo</th>
                                    <th>Categoría</th>
                                    <th>Cantidad</th>
                                    <th>Unidad</th> <!-- New column for Unit -->
                                    <th>Ubicación</th>
                                    <th>Stock Mínimo</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${inventoryItemsToPrint.map(item => `
                                    <tr>
                                        <td>${item.itemId}</td>
                                        <td>${item.name}</td>
                                        <td>${item.category}</td>
                                        <td>${item.quantity}</td>
                                        <td>${item.unit}</td> <!-- Display unit -->
                                        <td>${item.location}</td>
                                        <td>${item.minStock}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.open();
                printWindow.document.write(inventoryContent);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
            } else {
                showMessage("No se pudo abrir la ventana de impresión. Asegúrese de que los bloqueadores de pop-ups estén desactivados.", true);
            }
        }

        // Function to toggle collapsible content
        function toggleCollapsible(contentId, buttonId) {
            const content = document.getElementById(contentId);
            const button = document.getElementById(buttonId);
            if (content && button) {
                content.classList.toggle('expanded');
                // The chevron icon is a child of the button, so we can toggle classes on the button itself
                // and use CSS to rotate the chevron based on the 'expanded' class on the content.
            } else {
                console.error(`Error: Contenido o botón no encontrado para ID: ${contentId}, ${buttonId}`);
            }
        }

        // NEW: Function to render charts based on inventory data
        function renderCharts(items) {
            const categories = {};
            items.forEach(item => {
                if (categories[item.category]) {
                    categories[item.category] += item.quantity;
                } else {
                    categories[item.category] = item.quantity;
                }
            });

            const chartLabels = Object.keys(categories);
            const chartData = Object.values(categories);

            const ctx = document.getElementById('inventoryByCategoryChart').getContext('2d');

            // Destroy existing chart instance if it exists
            if (inventoryByCategoryChartInstance) {
                inventoryByCategoryChartInstance.destroy();
            }

            inventoryByCategoryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Cantidad de Artículos por Categoría',
                        data: chartData,
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 159, 64, 0.6)',
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(201, 203, 207, 0.6)',
                            'rgba(255, 205, 86, 0.6)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(201, 203, 207, 1)',
                            'rgba(255, 205, 86, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Categoría'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Distribución de Inventario por Categoría'
                        }
                    }
                }
            });
        }

        // NEW: Function to render reorder suggestions
        function renderReorderSuggestions(items) {
            const reorderTableBody = document.getElementById('reorder-list');
            reorderTableBody.innerHTML = ''; // Clear current table
            reorderItemsToPrint = []; // Clear items for printing
            let hasReorderItems = false;

            items.forEach(item => {
                if (item.quantity <= item.minStock) {
                    hasReorderItems = true;
                    const suggestedQuantity = Math.max(1, item.minStock * 2 - item.quantity); // Suggest to double min stock, or at least 1
                    
                    reorderItemsToPrint.push({ // Add to list for printing
                        itemId: item.itemId,
                        name: item.name,
                        currentQuantity: item.quantity,
                        minStock: item.minStock,
                        suggestedQuantity: suggestedQuantity,
                        unit: item.unit || ''
                    });

                    const newRow = reorderTableBody.insertRow();
                    newRow.classList.add('hover:bg-gray-50');

                    newRow.insertCell().textContent = item.itemId;
                    newRow.insertCell().textContent = item.name;
                    newRow.insertCell().textContent = `${item.quantity} ${item.unit || ''}`;
                    newRow.insertCell().textContent = `${item.minStock} ${item.unit || ''}`;
                    newRow.insertCell().textContent = `${suggestedQuantity} ${item.unit || ''}`;
                }
            });

            const noReorderItemsMessage = document.getElementById('no-reorder-items');
            if (hasReorderItems) {
                noReorderItemsMessage.classList.add('hidden');
            } else {
                noReorderItemsMessage.classList.remove('hidden');
            }
        }

        // NEW: Function to print reorder suggestions
        function printReorderSuggestions() {
            const now = new Date().toLocaleString('es-ES', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', hour12: false
            }).replace(/\//g, '-');
            
            const printUserId = userId; 

            let reorderContent = `
                <html lang="es">
                <head>
                    <title>Sugerencias de Reabastecimiento</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 20px; color: #333; }
                        .report-container { 
                            width: 80%; 
                            margin: 0 auto; 
                            border: 1px solid #ccc; 
                            padding: 20px; 
                            box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        }
                        .report-header { 
                            display: flex; 
                            justify-content: space-between; 
                            align-items: center; 
                            margin-bottom: 20px; 
                            border-bottom: 2px solid #1e40af; 
                            padding-bottom: 10px;
                            position: relative;
                        }
                        .report-header h1 { 
                            text-align: left; 
                            color: #1e40af; 
                            margin: 0; 
                            font-size: 2em; 
                            flex-grow: 1;
                        }
                        .report-header .print-logo-left {
                            max-width: 100px; 
                            height: auto; 
                            border-radius: 8px;
                            position: absolute;
                            left: 0;
                            top: 50%;
                            transform: translateY(-50%);
                        }
                        .report-header .print-logo-right { 
                            max-width: 100px; 
                            height: auto; 
                            border-radius: 8px;
                            position: absolute;
                            right: 0;
                            top: 50%;
                            transform: translateY(-50%);
                        }
                        .header-info-block { 
                            display: flex; 
                            justify-content: space-between; 
                            margin-bottom: 20px; 
                            font-size: 0.9em; 
                            line-height: 1.5;
                            flex-wrap: wrap;
                        }
                        .header-info-block div { 
                            width: 48%; 
                            margin-bottom: 10px;
                        }
                        .header-info-block div:last-child {
                            text-align: right;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-top: 20px; 
                            font-size: 0.9em;
                        }
                        th, td { 
                            border: 1px solid #ddd; 
                            padding: 8px; 
                            text-align: left; 
                        }
                        th { 
                            background-color: #f2f2f2; 
                            color: #555;
                        }
                        .created-by-text {
                            font-family: 'Bebas Neue', sans-serif !important; 
                            font-size: 0.8em !important;
                            color: #555 !important;
                            margin-top: 5px !important;
                            letter-spacing: 1px !important;
                        }
                        @media print {
                            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .report-container { width: 100%; border: none; padding: 0; box-shadow: none; }
                            .report-header { page-break-inside: avoid; }
                            table { page-break-inside: auto; }
                            tr { page-break-inside: avoid; page-break-after: auto; }
                            .report-header h1 {
                                margin: 0 120px; 
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="report-container">
                        <div class="report-header">
                            <img src="https://placehold.co/100x100/blue/white?text=LOGO_IZQUIERDA" onerror="this.onerror=null; this.src='https://placehold.co/100x100/blue/white?text=LOGO_ERROR_LEFT'" alt="Escudo de Honduras" class="print-logo-left">
                            <h1>Sugerencias de Reabastecimiento</h1>
                            <img src="https://placehold.co/100x100/blue/white?text=LOGO_DERECHA" onerror="this.onerror=null; this.src='https://placehold.co/100x100/blue/white?text=LOGO_ERROR_RIGHT'" alt="Logo de la Fuerza Aérea Hondureña" class="print-logo-right">
                        </div>
                        <div class="header-info-block">
                            <div>
                                <p><strong>Fecha de Impresión:</strong> ${now}</p>
                            </div>
                            <div>
                                <p><strong>Número de Parte de Usuario:</strong> ${printUserId}</p>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Número de Parte</th>
                                    <th>Nombre del Artículo</th>
                                    <th>Cantidad Actual</th>
                                    <th>Stock Mínimo</th>
                                    <th>Cantidad Sugerida</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reorderItemsToPrint.map(item => `
                                    <tr>
                                        <td>${item.itemId}</td>
                                        <td>${item.name}</td>
                                        <td>${item.currentQuantity} ${item.unit}</td>
                                        <td>${item.minStock} ${item.unit}</td>
                                        <td>${item.suggestedQuantity} ${item.unit}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${reorderItemsToPrint.length === 0 ? '<p style="text-align: center; margin-top: 20px;">No hay artículos que requieran reabastecimiento en este momento.</p>' : ''}
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.open();
                printWindow.document.write(reorderContent);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
            } else {
                showMessage("No se pudo abrir la ventana de impresión. Asegúrese de que los bloqueadores de pop-ups estén desactivados.", true);
            }
        }


        // REMOVED: Export to PDF/CSV functions (Improvement 4)
        // function exportToPdf(data, headers, title, filename) { ... }
        // function exportToCsv(data, headers, filename) { ... }
        // function getPrintableInventoryData() { ... }
        // function getPrintableMovementHistoryData() { ... }
        // function getPrintableInvoiceHistoryData() { ... }
        // function getPrintableReorderSuggestionsData() { ... }


        // --- Firestore Initialization and Data Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('loading-overlay').style.display = 'flex'; // Show loading

            // New: Timeout to hide loading overlay even if data fails to load
            const loadingTimeout = setTimeout(() => {
                hideLoadingOverlay();
                showMessage("La carga de datos iniciales tardó demasiado o falló. Verifique la conexión o las reglas de Firebase.", true);
            }, 7000); // Hide after 7 seconds

            try {
                // Ensure firebaseConfig is available before initializing
                if (!firebaseConfig) {
                    console.error("Firebase initialization skipped due to missing config. Please check your Firebase setup.");
                    clearTimeout(loadingTimeout);
                    hideLoadingOverlay();
                    return; // Exit if config is missing
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app); // Initialize Realtime Database

                // IMPORTANT: This onAuthStateChanged listener will handle both initial auth and subsequent login/logout
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in.
                        userId = user.uid; // Update userId with authenticated user's UID
                        currentUserIdentifier = user.email || user.uid; // Prioritize email
                        document.getElementById('user-id-display').textContent = `Número de Parte de Usuario: ${userId}`;
                        document.getElementById('current-user-email').textContent = user.email || "Usuario Anónimo";
                        document.getElementById('logged-out-view').classList.add('hidden');
                        document.getElementById('logged-in-view').classList.remove('hidden');
                        
                        // References for Realtime Database pointing to the PUBLIC data path
                        // All users (anonymous or logged in) will see the same data
                        inventoryRef = ref(db, `artifacts/${appId}/public/data/inventory`);
                        historyRef = ref(db, `artifacts/${appId}/public/data/movementHistory`);
                        invoiceHistoryRef = ref(db, `artifacts/${appId}/public/data/invoiceHistory`);
                        isAuthReady = true;
                        console.log("Firebase Auth está listo y referencias de Realtime Database establecidas.");


                        // Attach listeners only once after auth is ready and refs are set
                        onValue(inventoryRef, (snapshot) => {
                            const itemsObject = snapshot.val();
                            const itemsArray = [];
                            if (itemsObject) {
                                for (const key in itemsObject) {
                                    itemsArray.push({ id: key, ...itemsObject[key] });
                                }
                            }
                            renderInventory(itemsArray); // This now also triggers chart and reorder rendering
                            console.log("Inventario cargado/actualizado desde Realtime Database.");
                            initialDataLoadedCount++;
                            if (initialDataLoadedCount >= expectedInitialLoads) {
                                clearTimeout(loadingTimeout);
                                hideLoadingOverlay();
                            }
                        }, (error) => {
                            console.error("Error al escuchar el inventario de Realtime Database: ", error);
                            showMessage("Error al cargar el inventario: " + error.message, true); // Mostrar mensaje de error detallado
                            initialDataLoadedCount++;
                            if (initialDataLoadedCount >= expectedInitialLoads) {
                                clearTimeout(loadingTimeout);
                                hideLoadingOverlay();
                            }
                        });

                        onValue(historyRef, (snapshot) => {
                            const movementsObject = snapshot.val();
                            const movementsArray = [];
                            if (movementsObject) {
                                for (const key in movementsObject) {
                                    movementsArray.push({ id: key, ...movementsObject[key] });
                                }
                            }
                            renderHistory(movementsArray); // This also updates allMovementHistory
                            console.log("Historial de movimientos cargado/actualizado desde Realtime Database.");
                            initialDataLoadedCount++;
                            if (initialDataLoadedCount >= expectedInitialLoads) {
                                clearTimeout(loadingTimeout);
                                hideLoadingOverlay();
                            }
                        }, (error) => {
                            console.error("Error al escuchar el historial de movimientos de Realtime Database: ", error);
                            showMessage("Error al cargar el historial de movimientos: " + error.message, true); // Mostrar mensaje de error detallado
                            initialDataLoadedCount++;
                            if (initialDataLoadedCount >= expectedInitialLoads) {
                                clearTimeout(loadingTimeout);
                                hideLoadingOverlay();
                            }
                        });

                        onValue(invoiceHistoryRef, (snapshot) => {
                            const invoicesObject = snapshot.val();
                            const invoicesArray = [];
                            if (invoicesObject) {
                                for (const key in invoicesObject) {
                                    invoicesArray.push({ invoiceId: key, ...invoicesObject[key] });
                                }
                            }
                            renderInvoices(invoicesArray);
                            console.log("Historial de facturas cargado/actualizado desde Realtime Database.");
                            initialDataLoadedCount++;
                            if (initialDataLoadedCount >= expectedInitialLoads) {
                                clearTimeout(loadingTimeout);
                                hideLoadingOverlay();
                            }
                        }, (error) => {
                            console.error("Error al escuchar el historial de facturas de Realtime Database: ", error);
                            showMessage("Error al cargar el historial de facturas: " + error.message, true); // Mostrar mensaje de error detallado
                            initialDataLoadedCount++;
                            if (initialDataLoadedCount >= expectedInitialLoads) {
                                clearTimeout(loadingTimeout);
                                hideLoadingOverlay();
                            }
                        });

                    } else {
                        // User is signed out.
                        // Try to sign in anonymously. In Canvas, if __initial_auth_token is provided,
                        // this ensures the user is "authenticated" for Firebase rules that require request.auth != null.
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await signInAnonymously(auth); 
                                console.log("Signed in anonymously with custom token provided by Canvas environment.");
                            } catch (error) {
                                console.error("Error signing in anonymously:", error);
                                showMessage("Error al iniciar sesión anónimamente. Intente iniciar sesión con correo electrónico.", true);
                                clearTimeout(loadingTimeout);
                                hideLoadingOverlay();
                            }
                        } else {
                             // If no initial auth token, and no user logged in, then userId is truly 'anonymous'.
                             // The system will still attempt to load data from public paths, but write operations might fail
                             // if Firebase Security Rules require authentication.
                             userId = 'anonymous'; // Keep anonymous for display
                             currentUserIdentifier = 'Anónimo'; // Set identifier to 'Anónimo'
                             isAuthReady = true; // Still consider auth ready for public data access
                             document.getElementById('user-id-display').textContent = `Número de Parte de Usuario: Anónimo`;
                             document.getElementById('current-user-email').textContent = 'Anónimo';
                             document.getElementById('logged-out-view').classList.remove('hidden');
                             document.getElementById('logged-in-view').classList.add('hidden');

                             // Set public references even if no specific auth occurs, for read attempts
                             inventoryRef = ref(db, `artifacts/${appId}/public/data/inventory`);
                             historyRef = ref(db, `artifacts/${appId}/public/data/movementHistory`);
                             invoiceHistoryRef = ref(db, `artifacts/${appId}/public/data/invoiceHistory`);
                             console.log("Firebase Auth está listo (usuario anónimo) y referencias de Realtime Database establecidas.");

                             // Proceed to load data even if auth is truly anonymous
                             onValue(inventoryRef, (snapshot) => {
                                const itemsObject = snapshot.val();
                                const itemsArray = [];
                                if (itemsObject) {
                                    for (const key in itemsObject) {
                                        itemsArray.push({ id: key, ...itemsObject[key] });
                                    }
                                }
                                renderInventory(itemsArray); // This now also triggers chart and reorder rendering
                                console.log("Inventario cargado/actualizado desde Realtime Database (anónimo).");
                                initialDataLoadedCount++;
                                if (initialDataLoadedCount >= expectedInitialLoads) {
                                    clearTimeout(loadingTimeout);
                                    hideLoadingOverlay();
                                }
                            }, (error) => {
                                console.error("Error al escuchar el inventario de Realtime Database (anónimo): ", error);
                                showMessage("Error al cargar el inventario: " + error.message, true); // Mostrar mensaje de error detallado
                                initialDataLoadedCount++;
                                if (initialDataLoadedCount >= expectedInitialLoads) {
                                    clearTimeout(loadingTimeout);
                                    hideLoadingOverlay();
                                }
                            });

                            onValue(historyRef, (snapshot) => {
                                const movementsObject = snapshot.val();
                                const movementsArray = [];
                                if (movementsObject) {
                                    for (const key in movementsObject) {
                                        movementsArray.push({ id: key, ...movementsObject[key] });
                                    }
                                }
                                renderHistory(movementsArray); // This also updates allMovementHistory
                                console.log("Historial de movimientos cargado/actualizado desde Realtime Database (anónimo).");
                                initialDataLoadedCount++;
                                if (initialDataLoadedCount >= expectedInitialLoads) {
                                    clearTimeout(loadingTimeout);
                                    hideLoadingOverlay();
                                }
                            }, (error) => {
                                console.error("Error al escuchar el historial de movimientos de Realtime Database (anónimo): ", error);
                                showMessage("Error al cargar el historial de movimientos: " + error.message, true); // Mostrar mensaje de error detallado
                                initialDataLoadedCount++;
                                if (initialDataLoadedCount >= expectedInitialLoads) {
                                    clearTimeout(loadingTimeout);
                                    hideLoadingOverlay();
                                }
                            });

                            onValue(invoiceHistoryRef, (snapshot) => {
                                const invoicesObject = snapshot.val();
                                const invoicesArray = [];
                                if (invoicesObject) {
                                    for (const key in invoicesObject) {
                                        invoicesArray.push({ invoiceId: key, ...invoicesObject[key] });
                                    }
                                }
                                renderInvoices(invoicesArray);
                                console.log("Historial de facturas cargado/actualizado desde Realtime Database (anónimo).");
                                initialDataLoadedCount++;
                                if (initialDataLoadedCount >= expectedInitialLoads) {
                                    clearTimeout(loadingTimeout);
                                    hideLoadingOverlay();
                                }
                            }, (error) => {
                                console.error("Error al escuchar el historial de facturas de Realtime Database (anónimo): ", error);
                                showMessage("Error al cargar el historial de facturas: " + error.message, true); // Mostrar mensaje de error detallado
                                initialDataLoadedCount++;
                                if (initialDataLoadedCount >= expectedInitialLoads) {
                                    clearTimeout(loadingTimeout);
                                    hideLoadingOverlay();
                                }
                            });
                        }
                    }
                });

            } catch (e) {
                console.error("Error inicializando Firebase Realtime Database:", e);
                clearTimeout(loadingTimeout); // Clear timeout on initialization error
                hideLoadingOverlay(); // Hide overlay on initialization error
                showMessage("Error grave al inicializar la aplicación. Ver consola para más detalles: " + e.message, true); // Mostrar mensaje de error detallado
            }

            // --- Attach Other Event Listeners (ensure they are attached AFTER DOMContentLoaded) ---
            document.getElementById('open-delivery-invoice-modal-btn')?.addEventListener('click', openDeliveryInvoiceModal);
            // Changed: search-button now calls clearSearch instead of searchInventory
            document.getElementById('search-button')?.addEventListener('click', clearSearch);
            // Added: Input listener for real-time search
            document.getElementById('search-input')?.addEventListener('input', searchInventory);
            
            document.getElementById('cancel-withdrawal-btn')?.addEventListener('click', cancelWithdrawal);
            document.getElementById('confirm-withdrawal-btn')?.addEventListener('click', confirmWithdrawal);
            document.getElementById('delivery-search-input')?.addEventListener('input', filterDeliverySearch); 
            document.getElementById('cancel-delivery-invoice-btn')?.addEventListener('click', cancelDeliveryInvoice);
            document.getElementById('confirm-delivery-invoice-btn')?.addEventListener('click', confirmDeliveryInvoice);
            document.getElementById('print-delivery-invoice-btn')?.addEventListener('click', printDeliveryInvoice);
            // Updated clear history button logic for collapsible content
            document.getElementById('clear-history-btn')?.addEventListener('click', clearHistory);
            document.getElementById('clear-invoice-history-btn')?.addEventListener('click', clearInvoiceHistory);
            document.getElementById('critical-items-card')?.addEventListener('click', filterCriticalItems);
            document.getElementById('print-inventory-btn')?.addEventListener('click', printInventory);
            document.getElementById('print-reorder-btn')?.addEventListener('click', printReorderSuggestions); // NEW: Reorder print button
            
            // Custom confirm modal buttons must be attached here to ensure they exist
            // Using optional chaining and specific error handling for robustness
            const customConfirmOkButton = document.getElementById('confirm-confirm-ok'); 
            const customConfirmCancelButton = document.getElementById('custom-confirm-cancel');

            if (customConfirmOkButton) {
                customConfirmOkButton.onclick = () => {
                    document.getElementById('custom-confirm-modal')?.classList.remove('flex');
                    if (confirmResolver) {
                        confirmResolver(true);
                        confirmResolver = null;
                    }
                };
            } else {
                console.warn("Botón 'confirm-confirm-ok' no encontrado. La funcionalidad de confirmación puede no funcionar.");
            }

            if (customConfirmCancelButton) {
                customConfirmCancelButton.onclick = () => {
                    document.getElementById('custom-confirm-modal')?.classList.remove('flex');
                    if (confirmResolver) {
                        confirmResolver(false);
                        confirmResolver = null;
                    }
                };
            } else {
                console.warn("Botón 'custom-confirm-cancel' no encontrado. La funcionalidad de confirmación puede no funcionar.");
            }

            // Event listeners for the new edit item modal
            document.getElementById('cancel-edit-item-btn')?.addEventListener('click', cancelEditItem);
            document.getElementById('edit-item-form')?.addEventListener('submit', confirmEditItem);

            // Add listeners for collapsible sections
            document.getElementById('toggle-history-btn')?.addEventListener('click', () => {
                toggleCollapsible('history-content', 'toggle-history-btn');
            });
            document.getElementById('toggle-invoice-history-btn')?.addEventListener('click', () => {
                toggleCollapsible('invoice-history-content', 'toggle-invoice-history-btn');
            });
            document.getElementById('toggle-reorder-btn')?.addEventListener('click', () => { // NEW: Reorder toggle button
                toggleCollapsible('reorder-content', 'toggle-reorder-btn');
            });
            document.getElementById('toggle-inventory-btn')?.addEventListener('click', () => { // NEW: Inventory toggle button
                toggleCollapsible('inventory-content', 'toggle-inventory-btn');
            });

            // Image search modal buttons (modified logic)
            const imageSearchModal = document.getElementById('image-search-modal');
            const urlSearchContent = document.getElementById('url-search-content');
            const cameraSearchContent = document.getElementById('camera-search-content');
            const openUrlSearchOptionBtn = document.getElementById('open-url-search-option-btn');
            const openCameraSearchOptionBtn = document.getElementById('open-camera-search-option-btn');
            const cancelImageSearchUrlBtn = document.getElementById('cancel-image-search-url-btn');
            const confirmImageSearchUrlBtn = document.getElementById('confirm-image-search-url-btn');
            const cancelImageSearchCameraBtn = document.getElementById('cancel-image-search-camera-btn');

            document.getElementById('open-image-search-modal-btn')?.addEventListener('click', () => {
                // Show options and hide all content initially
                imageSearchModal.classList.add('flex');
                urlSearchContent.classList.add('hidden');
                cameraSearchContent.classList.add('hidden');
                document.getElementById('image-search-options').classList.remove('hidden');
                stopCamera(); // Ensure camera is off when modal is first opened to choose option
            });

            openUrlSearchOptionBtn?.addEventListener('click', () => {
                document.getElementById('image-search-options').classList.add('hidden');
                urlSearchContent.classList.remove('hidden');
                cameraSearchContent.classList.add('hidden');
                document.getElementById('image-url-input').value = '';
                stopCamera(); // Stop camera if switching from camera view
            });

            openCameraSearchOptionBtn?.addEventListener('click', () => {
                document.getElementById('image-search-options').classList.add('hidden');
                urlSearchContent.classList.add('hidden');
                cameraSearchContent.classList.remove('hidden');
                startCamera(); // Start camera when camera option is selected
            });

            cancelImageSearchUrlBtn?.addEventListener('click', () => {
                imageSearchModal.classList.remove('flex');
                stopCamera(); // Ensure camera is off when modal is closed
            });

            confirmImageSearchUrlBtn?.addEventListener('click', () => {
                const imageUrl = document.getElementById('image-url-input').value.trim();
                if (imageUrl) {
                    reverseImageSearchGoogle(imageUrl);
                    imageSearchModal.classList.remove('flex');
                } else {
                    showMessage('Por favor, introduce una URL de imagen válida.', true);
                }
                stopCamera(); // Ensure camera is off after URL search
            });

            cancelImageSearchCameraBtn?.addEventListener('click', () => {
                imageSearchModal.classList.remove('flex');
                stopCamera(); // Ensure camera is off when modal is closed
            });

            captureImageBtn?.addEventListener('click', captureImage);
            retakeImageBtn?.addEventListener('click', startCamera); // Retake simply restarts the camera
            downloadImageBtn?.addEventListener('click', downloadCapturedImage); // NEW: Attach download function
            searchCapturedImageBtn?.addEventListener('click', searchCapturedImage);


            // NEW: Item History Modal Event Listener
            document.getElementById('close-item-history-btn')?.addEventListener('click', closeItemHistoryModal);

            // Add listener for add item form
            document.getElementById('add-item-form')?.addEventListener('submit', async function(event) { // Usar optional chaining para seguridad
                event.preventDefault(); 

                if (!isAuthReady) {
                    showMessage("La base de datos no está lista. Intente de nuevo en unos segundos.", true);
                    return;
                }

                // Convert to uppercase and standardize where applicable
                const itemId = document.getElementById('item-id').value.trim().toUpperCase();
                const itemName = document.getElementById('item-name').value.trim().toUpperCase();
                const itemCategory = standardizeAndValidateCategory(document.getElementById('item-category').value); // Use new standardization function
                const itemQuantity = parseInt(document.getElementById('item-quantity').value);
                const itemUnit = document.getElementById('item-unit').value; 
                const itemLocation = document.getElementById('item-location').value.trim();
                const itemMinStock = parseInt(document.getElementById('item-min-stock').value);

                if (!itemId || !itemName || !itemCategory || isNaN(itemQuantity) || !itemUnit || !itemLocation || isNaN(itemMinStock)) {
                    showMessage('Por favor, complete todos los campos correctamente (incluyendo la unidad de medida y la ubicación).', true);
                    return;
                }
                if (itemQuantity < 0 || itemMinStock < 0) {
                     showMessage('La cantidad y el stock mínimo no pueden ser números negativos.', true);
                     return;
                }
                if (itemUnit === "") {
                    showMessage('Por favor, seleccione una unidad de medida.', true);
                    return;
                }

                try {
                    let itemExists = false;
                    let existingItemKey = null;
                    let existingItemQuantity = 0;
                    let existingItemLocation = ''; // New variable to store existing item's location
                    let existingItemUnit = ''; // New variable to store existing item's unit

                    const existingItem = currentInventoryItems.find(item => item.itemId === itemId);
                    
                    if (existingItem) {
                        itemExists = true;
                        existingItemKey = existingItem.id;
                        existingItemQuantity = existingItem.quantity;
                        existingItemLocation = existingItem.location; // Get existing location
                        existingItemUnit = existingItem.unit || ''; // Get existing unit
                        console.log(`Artículo existente encontrado: ${itemName} con ID Firebase: ${existingItemKey}`);
                    }

                    if (itemExists) {
                        // NEW: Show confirmation modal with location
                        const confirmed = await showConfirm(
                            'Artículo Existente',
                            `El artículo "${existingItem.name}" (Número de Parte: ${itemId}) ya existe en el inventario.` +
                            `\nCantidad actual: ${existingItemQuantity} ${existingItemUnit}.` +
                            `\nUbicación: ${existingItemLocation}.` +
                            `\n¿Desea añadir ${itemQuantity} unidades a este artículo?`
                        );

                        if (!confirmed) {
                            showMessage('Adición de stock cancelada.', false);
                            document.getElementById('add-item-form').reset();
                            document.getElementById('item-location').value = '';
                            return; // Stop execution if cancelled
                        }

                        const newTotalQuantity = existingItemQuantity + itemQuantity;
                        // Point to public inventory
                        const itemDbRef = ref(db, `artifacts/${appId}/public/data/inventory/${existingItemKey}`);
                        // Update category, name, unit, location, minStock even if item already exists
                        await update(itemDbRef, { 
                            quantity: newTotalQuantity, 
                            name: itemName, // Update name
                            category: itemCategory, // Update category
                            unit: itemUnit, 
                            location: itemLocation, 
                            minStock: itemMinStock 
                        }); 
                        await addMovementToHistory(itemId, itemName, 'Actualización (Ingreso)', itemQuantity, 'Formulario de Entrada', currentUserIdentifier);
                        showMessage(`Cantidad de "${itemName}" actualizada a ${newTotalQuantity} ${itemUnit} en Realtime Database!`, false);
                        console.log(`Artículo "${itemName}" (ID: ${itemId}) actualizado en Realtime Database.`);
                    } else {
                        // Point to public inventory
                        await push(inventoryRef, {
                            itemId: itemId, 
                            name: itemName,
                            category: itemCategory,
                            quantity: itemQuantity,
                            unit: itemUnit,
                            location: itemLocation,
                            minStock: itemMinStock,
                            createdAt: new Date().toISOString()
                        });
                        await addMovementToHistory(itemId, itemName, 'Ingreso', itemQuantity, 'Formulario de Entrada', currentUserIdentifier);
                        showMessage('Artículo añadido con éxito a Realtime Database!', false);
                        console.log(`Nuevo artículo "${itemName}" (ID: ${itemId}) añadido a Realtime Database.`);
                    }

                    document.getElementById('add-item-form').reset();
                    document.getElementById('item-location').value = ''; 

                } catch (e) {
                    console.error("Error al añadir/actualizar el artículo en Realtime Database: ", e);
                    showMessage("Error al añadir/actualizar el artículo. Intente de nuevo: " + e.message, true); // Mostrar mensaje de error detallado
                }
            });


            // Authentication button listeners
            document.getElementById('login-btn')?.addEventListener('click', async () => {
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage("Sesión iniciada correctamente.", false);
                } catch (error) {
                    console.error("Error al iniciar sesión:", error);
                    showMessage(`Error al iniciar sesión: ${error.message}`, true);
                }
            });

            document.getElementById('register-btn')?.addEventListener('click', async () => {
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showMessage("Usuario registrado y sesión iniciada correctamente.", false);
                } catch (error) {
                    console.error("Error al registrar usuario:", error);
                    showMessage(`Error al registrar: ${error.message}`, true);
                }
            });

            document.getElementById('logout-btn')?.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showMessage("Sesión cerrada correctamente.", false);
                    // Reset UI for logged out view
                    document.getElementById('logged-out-view').classList.remove('hidden');
                    document.getElementById('logged-in-view').classList.add('hidden');
                    document.getElementById('user-id-display').textContent = 'Número de Parte de Usuario: Anónimo';
                    document.getElementById('current-user-email').textContent = 'Anónimo';
                    userId = 'anonymous'; // Reset userId on logout
                    currentUserIdentifier = 'Anónimo'; // Reset identifier
                    // When logging out, clear data and attempt anonymous sign-in to reload public data
                    // This is important because public data access requires auth != null, even if it's anonymous
                    await signInAnonymously(auth); // Re-authenticate anonymously to allow reading public data
                } catch (error) {
                    console.error("Error al cerrar sesión:", error);
                    showMessage(`Error al cerrar sesión: ${error.message}`, true);
                }
            });

        });
    </script>

</body>
</html>
